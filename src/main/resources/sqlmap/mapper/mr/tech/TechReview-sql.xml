<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mr.tech">
    <resultMap id="mrTechMap" type="com.mr.tech.domain.TechReviewVO">
        <id property="mrTechRvNo" column="MR_TECH_RV_NO" />
        <result property="mrReqNo" column="MR_REQ_NO" />
        <result property="mrNo" column="MR_NO" />
        <result property="mrReqTitle" column="MR_REQ_TITLE" />
        <result property="plant" column="PLANT" />
        <result property="plantNm" column="PLANT_NM" />
        <result property="reqClCd" column="REQ_CL_CD" />
        <result property="reqClCdNm" column="REQ_CL_CD_NM" />
        <result property="reqClDtlCd" column="REQ_CL_DTL_CD" />
        <result property="reqClDtlCdNm" column="REQ_CL_DTL_CD_NM" />
        <result property="workPsblClCd" column="WORK_PSBL_CL_CD" />
        <result property="workPsblClCdNm" column="WORK_PSBL_CL_CD_NM" />
        <result property="workPsblDt" column="WORK_PSBL_DT" />

        <result property="qualEptEftCtt" column="QUAL_EPT_EFT_CTT" />
        <result property="quanEptEftCtt" column="QUAN_EPT_EFT_CTT" />
        <result property="quanEptEftCd" column="QUAN_EPT_EFT_CD" />
        <result property="quanEptEftCdNm" column="QUAN_EPT_EFT_CD_NM" />

        <result property="quanEff" column="QUAN_EFF" />
        <result property="quanEffCd" column="QUAN_EFF_CD" />
        <result property="qualEff" column="QUAL_EFF" />
        
        <result property="zoutqty" column="ZOUTQTY" />
        <result property="zoutamt" column="ZOUTAMT" />
        
        <result property="totRvSugg1" column="TOT_RV_SUGG_1" />
        <result property="totRvSugg2" column="TOT_RV_SUGG_2" />
        <result property="invstCd" column="INVST_CD" />
        <result property="invstPurpCd" column="INVST_PURP_CD" />

        <result property="delYn" column="DEL_YN" />
        <result property="fstRgstDt" column="FST_RGST_DT" />
        <result property="fstRgstr" column="FST_RGSTR" />
        <result property="lastChgDt" column="LAST_CHG_DT" />
        <result property="lastChgr" column="LAST_CHGR" />
        <collection property="rvRsts" ofType="com.mr.common.domain.MrRvRstVO" column="{mrReqNo=MR_REQ_NO, itemCd=ITEM_CD" select="mr.rvRst.selectMrRvRst" />
        <collection property="equips" ofType="com.mr.mrrq.domain.MrReqEquipVO" column="MR_REQ_NO" select="mr.mrReq.selectMrReqEquip" />
        <collection property="procs" ofType="com.mr.mrrq.domain.MrReqProcVO" column="MR_REQ_NO" select="mr.mrReq.selectMrReqProc" />        
        <collection property="appLine" ofType="com.mr.step.domain.ChrgrChgHist" column="{mrReqNo=MR_REQ_NO, mrStepCd=MR_STEP_CD} " select="mr.step.selectAppLine" />
        <collection property="jobs" ofType="com.mr.step.domain.ChrgrChgHist" column="{mrReqNo=MR_REQ_NO, mrStepCd=MR_STEP_CD} " select="mr.step.selectJobLine" />
    </resultMap>
	
    <select id="selectMrTechReview" resultMap="mrTechMap">
    	--기술검토항목조회selectMrTechReview
        SELECT NVL(TECH.MR_TECH_RV_NO,0) AS MR_TECH_RV_NO,
               MR.MR_NO,
               MR.MR_REQ_NO,
               MR.MR_REQ_TITLE,
               MR.PLANT,
               'TECH' AS ITEM_CD,
               'Z0020' AS MR_STEP_CD,
               PLANT.MR_COMM_NM AS PLANT_NM,
               MR.REQ_CL_CD,
               REQ_CD.MR_COMM_NM AS REQ_CL_CD_NM,
               MR.REQ_CL_DTL_CD,
               REQ_DTL_CD.MR_COMM_NM AS REQ_CL_DTL_CD_NM,
               MR.WORK_PSBL_CL_CD,
               WORK_CD.MR_COMM_NM AS WORK_PSBL_CL_CD_NM,
               MR.WORK_PSBL_DT,
               MR.QUAL_EPT_EFT_CTT,
               MR.QUAN_EPT_EFT_CTT,
               MR.QUAN_EPT_EFT_CD,
               QUAN_CD.MR_COMM_NM AS QUAN_EPT_EFT_CD_NM,
               TECH.QUAN_EFF,
               TECH.QUAN_EFF_CD,
               TECH.QUAL_EFF,
               TECH.ZOUTQTY,
               TECH.ZOUTAMT,
               TECH.TOT_RV_SUGG_1,
               TECH.TOT_RV_SUGG_2,
               TECH.INVST_CD,
               TECH.INVST_PURP_CD,
               TECH.FST_RGST_DT,
               TECH.FST_RGSTR,
               TECH.LAST_CHG_DT,
               TECH.LAST_CHGR
          FROM MR_REQ_MST MR,
               (SELECT *
                  FROM MR_TECH_RV
                 WHERE DEL_YN=0
                 AND STEP_TYPE is null    /*2025.11.03 IJS MR수행용 제외처리 */
                 ) TECH,
               (SELECT *
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'PLANT')PLANT,
               (SELECT *
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'REQ')REQ_CD,
               (SELECT *
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'REQ_DET')REQ_DTL_CD,
               (SELECT *
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'WORK')WORK_CD,
               (SELECT *
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'QN_UNIT')QUAN_CD
         WHERE MR.MR_REQ_NO = TECH.MR_REQ_NO(+)
           AND MR.REQ_CL_CD = REQ_CD.MR_COMM_CD(+)
           AND MR.REQ_CL_DTL_CD = REQ_DTL_CD.MR_COMM_CD(+)
           AND MR.WORK_PSBL_CL_CD = WORK_CD.MR_COMM_CD(+)
           AND MR.QUAN_EPT_EFT_CD = QUAN_CD.MR_COMM_CD(+)
           AND MR.PLANT = PLANT.MR_COMM_CD(+)
           AND MR.MR_REQ_NO = #{mrReqNo}
           AND MR.DEL_YN=0
    </select>
    <resultMap id="mrCompleteMap" type="com.mr.tech.domain.TechReviewVO">
        <id property="mrTechRvNo" column="MR_TECH_RV_NO" />
        <result property="mrReqNo" column="MR_REQ_NO" />
        <result property="mrNo" column="MR_NO" />
        <result property="mrReqTitle" column="MR_REQ_TITLE" />
        <result property="plant" column="PLANT" />
        <result property="plantNm" column="PLANT_NM" />
        <result property="reqClCd" column="REQ_CL_CD" />
        <result property="reqClCdNm" column="REQ_CL_CD_NM" />
        <result property="reqClDtlCd" column="REQ_CL_DTL_CD" />
        <result property="reqClDtlCdNm" column="REQ_CL_DTL_CD_NM" />
        <result property="workPsblClCd" column="WORK_PSBL_CL_CD" />
        <result property="workPsblClCdNm" column="WORK_PSBL_CL_CD_NM" />
        <result property="workPsblDt" column="WORK_PSBL_DT" />

        <result property="qualEptEftCtt" column="QUAL_EPT_EFT_CTT" />
        <result property="quanEptEftCtt" column="QUAN_EPT_EFT_CTT" />
        <result property="quanEptEftCd" column="QUAN_EPT_EFT_CD" />
        <result property="quanEptEftCdNm" column="QUAN_EPT_EFT_CD_NM" />

        <result property="quanEff" column="QUAN_EFF" />
        <result property="quanEffCd" column="QUAN_EFF_CD" />
        <result property="qualEff" column="QUAL_EFF" />
        <result property="totRvSugg1" column="TOT_RV_SUGG_1" />
        <result property="totRvSugg2" column="TOT_RV_SUGG_2" />
        <result property="invstCd" column="INVST_CD" />
        <result property="invstNm" column="INVST_NM" />
        <result property="invstPurpCd" column="INVST_PURP_CD" />
        <result property="invstPurpNm" column="INVST_PURP_NM" />
        
        <result property="mrConnTitle" column="MR_CONN_TITLE" />
        <result property="mrConnBdoy" column="MR_CONN_BODY" />

        <result property="delYn" column="DEL_YN" />
        <result property="fstRgstDt" column="FST_RGST_DT" />
        <result property="fstRgstr" column="FST_RGSTR" />
        <result property="lastChgDt" column="LAST_CHG_DT" />
        <result property="lastChgr" column="LAST_CHGR" />
        <collection property="rvRsts" ofType="com.mr.common.domain.MrRvRstVO" column="{mrReqNo=MR_REQ_NO, itemCd=ITEM_CD_LIKE" select="mr.rvRst.selectMrRvRst" />
        <collection property="equips" ofType="com.mr.mrrq.domain.MrReqEquipVO" column="MR_REQ_NO" select="mr.mrReq.selectMrReqEquip" />
        <collection property="procs" ofType="com.mr.mrrq.domain.MrReqProcVO" column="MR_REQ_NO" select="mr.mrReq.selectMrReqProc" />
        <collection property="appLine" ofType="com.mr.step.domain.ChrgrChgHist" column="{mrReqNo=MR_REQ_NO, mrStepCd=MR_STEP_CD} " select="mr.step.selectAppLine" />
        <collection property="jobs" ofType="com.mr.step.domain.ChrgrChgHist" column="{mrReqNo=MR_REQ_NO, mrStepCd=MR_THCH_STEP_CD} " select="mr.step.selectJobLine" />
    </resultMap>

    <select id="selectMrComplete" resultMap="mrCompleteMap">
    	--타당성검토확인
        SELECT NVL(TECH.MR_TECH_RV_NO,0) AS MR_TECH_RV_NO,
               MR.MR_NO,
               MR.MR_REQ_NO,
               MR.MR_REQ_TITLE,
               MR.PLANT,
               'TECH' AS ITEM_CD_LIKE,
               'Z0030' AS MR_STEP_CD,
               'Z0020' AS MR_THCH_STEP_CD,
               PLANT.MR_COMM_NM AS PLANT_NM,
               MR.REQ_CL_CD,
               REQ_CD.MR_COMM_NM AS REQ_CL_CD_NM,
               MR.REQ_CL_DTL_CD,
               REQ_DTL_CD.MR_COMM_NM AS REQ_CL_DTL_CD_NM,
               MR.WORK_PSBL_CL_CD,
               WORK_CD.MR_COMM_NM AS WORK_PSBL_CL_CD_NM,
               MR.WORK_PSBL_DT,
               MR.QUAL_EPT_EFT_CTT,
               MR.QUAN_EPT_EFT_CTT,
               MR.QUAN_EPT_EFT_CD,
               QUAN_CD.MR_COMM_NM AS QUAN_EPT_EFT_CD_NM,
               TECH.QUAN_EFF,
               TECH.QUAN_EFF_CD,
               TECH.QUAL_EFF,
               TECH.ZOUTQTY,
               TECH.ZOUTAMT,
               TECH.TOT_RV_SUGG_1,
               TECH.TOT_RV_SUGG_2,
               TECH.INVST_CD,
               INVST_CD.MR_COMM_NM INVST_NM,
               TECH.INVST_PURP_CD,
               INVST_PURP_CD.MR_COMM_NM INVST_PURP_NM,
               TECH.FST_RGSTR,
               TECH.LAST_CHG_DT,
               TECH.LAST_CHGR,
               TECH.FST_RGST_DT
          FROM MR_REQ_MST MR,
               (SELECT *
                  FROM MR_TECH_RV
                 WHERE DEL_YN=0
                 AND STEP_TYPE is null     /*2025.11.03 IJS MR수행용 제외처리 */
                 ) TECH,
               (SELECT *
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'PLANT')PLANT,
               (SELECT *
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'REQ')REQ_CD,
               (SELECT *
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'REQ_DET')REQ_DTL_CD,
               (SELECT *
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'WORK')WORK_CD,
               (SELECT *
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'QN_UNIT')QUAN_CD,
               (SELECT *
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'IVST')INVST_CD,
                 (SELECT * 
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'IVST_PUR')INVST_PURP_CD
         WHERE MR.MR_REQ_NO = TECH.MR_REQ_NO(+)
           AND MR.REQ_CL_CD = REQ_CD.MR_COMM_CD(+)
           AND MR.REQ_CL_DTL_CD = REQ_DTL_CD.MR_COMM_CD(+)
           AND MR.WORK_PSBL_CL_CD = WORK_CD.MR_COMM_CD(+)
           AND MR.QUAN_EPT_EFT_CD = QUAN_CD.MR_COMM_CD(+)
           AND TECH.INVST_CD = INVST_CD.MR_COMM_CD(+)
           AND TECH.INVST_PURP_CD = INVST_PURP_CD.MR_COMM_CD(+)
           AND MR.PLANT = PLANT.MR_COMM_CD(+)
           AND MR.MR_REQ_NO = #{mrReqNo}
           AND MR.DEL_YN=0
    </select>
        <insert id="insertMrTechReview" parameterType="com.mr.tech.domain.TechReviewVO">
        <selectKey keyProperty="mrTechRvNo" resultType="int" order="BEFORE">
            SELECT NVL(MAX(MR_TECH_RV_NO),0)+1
              FROM MR_TECH_RV
        </selectKey>
        INSERT INTO MR_TECH_RV(
                    MR_TECH_RV_NO,
                    MR_REQ_NO,
                    QUAN_EFF,
                    QUAN_EFF_CD,
                    QUAL_EFF,
                    ZOUTQTY,
               		ZOUTAMT,
                    TOT_RV_SUGG_1,
                    TOT_RV_SUGG_2,
                    INVST_CD,
                    INVST_PURP_CD,
                    DEL_YN,
                    FST_RGST_DT,
                    FST_RGSTR,
                    LAST_CHG_DT,
                    LAST_CHGR
             ) VALUES ( #{mrTechRvNo},
                        #{mrReqNo},
                        #{quanEff},
                        #{quanEffCd},
                        #{qualEff},
                        #{zoutqty},
                        #{zoutamt},
                        #{totRvSugg1},
                        #{totRvSugg2},
                        #{invstCd},
                        #{invstPurpCd},
                        0,
                        SYSDATE,
                        #{loginEmpNo},
                        SYSDATE,
                        #{loginEmpNo} )
    </insert>

   <update id="updateMrTechReviewDelYn" parameterType="map">
        UPDATE MR_TECH_RV
           SET DEL_YN=1,
               LAST_CHG_DT = SYSDATE,
               LAST_CHGR = #{loginEmpNo}
         WHERE MR_REQ_NO = #{mrReqNo}
           AND DEL_YN=0
    </update>

       <update id="updateMrTechReview" parameterType="map">
       --updateMrTechReview(기술 및 타당성 검토 테이블 업데이트)
        UPDATE MR_TECH_RV
           SET QUAN_EFF = #{quanEff},
               QUAN_EFF_CD = #{quanEffCd},
               QUAL_EFF = #{qualEff},
               <if test="zoutqty != null">
               ZOUTQTY = #{zoutqty},
               </if>
               <if test="zoutamt != null">
               ZOUTAMT = #{zoutamt},
               </if>
               TOT_RV_SUGG_1 = #{totRvSugg1},
               TOT_RV_SUGG_2 = #{totRvSugg2},
               INVST_CD = #{invstCd},
               INVST_PURP_CD = #{invstPurpCd},
               LAST_CHG_DT = SYSDATE,
               LAST_CHGR = #{loginEmpNo}
         WHERE MR_REQ_NO = #{mrReqNo}
           AND DEL_YN=0
    </update>
    
       <update id="updateProjectEngineer" parameterType="map">
       --updateProjectEngineer(반려 후 프로젝트 엔지니어 삭제처리 복구)
		UPDATE MR_REQ_CHRGR_CHG_HIST
		   SET EFF_END_DTM = '99991231235959'
		 WHERE 1=1
		   AND MR_REQ_NO = #{mrReqNo} 
	   	   AND CHRGR_CL_CD = 'Z02I' 
		   AND SUBSTR(EFF_END_DTM,1,8) = TO_CHAR(SYSDATE, 'YYYYMMDD')
    </update>    

</mapper>