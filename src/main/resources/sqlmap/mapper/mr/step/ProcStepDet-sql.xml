<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mr.step">
    <resultMap id="procStepDetMap" type="com.mr.step.domain.MrReqProcStepDetVO">
        <id property="mrReqProcStepDetNo" column="MR_REQ_PROC_STEP_DET_NO" />
        <result property="mrReqProcStepNo" column="MR_REQ_PROC_STEP_NO" />
        <result property="mrReqNo" column="MR_REQ_NO" />
        <result property="mrStepCd" column="MR_STEP_CD" />
        <result property="procStCd" column="PROC_ST_CD" />
        <result property="jobRvCd" column="JOB_RV_CD" />
        <result property="mrProcStepDetClCd" column="MR_PROC_STEP_DET_CL_CD" />
        <result property="rvReqCtt" column="RV_REQ_CTT" />
        <result property="reqDt" column="REQ_DT" />
        <result property="endDt" column="END_DT" />
        <result property="procTrmClCd" column="PROC_TRM_CL_CD" />
        <result property="fstProcTrmDt" column="FST_PROC_TRM_DT" />
        <result property="scndProcTrmDt" column="SCND_PROC_TRM_DT" />
        <result property="thrdProcTrmDt" column="THRD_PROC_TRM_DT" />
        <result property="delYn" column="DEL_YN" />
        <result property="fstRgstDt" column="FST_RGST_DT" />
        <result property="fstRgstr" column="FST_RGSTR" />
        <result property="lastChgDt" column="LAST_CHG_DT" />
        <result property="lastChgr" column="LAST_CHGR" />
        <result property="connIfName" column="IF_NAME" />
        <result property="connIfStatGubun" column="IF_STAT_CD" />
    </resultMap>

    <insert id="insertMrReqProcStepDet" parameterType="com.mr.step.domain.MrReqProcStepDetVO">
     <selectKey keyProperty="mrReqProcStepDetNo" resultType="int" order="BEFORE">
            SELECT MR_REQ_PROC_STEP_DET_SEQ.NEXTVAL
              FROM DUAL
        </selectKey>    
        --insertMrReqProcStepDet(step det 입력 1)
        INSERT INTO MR_REQ_PROC_STEP_DET (
                    MR_REQ_PROC_STEP_DET_NO,
                    MR_REQ_PROC_STEP_NO,
                    MR_REQ_NO,
                    MR_STEP_CD,
                    PROC_ST_CD,
                    JOB_RV_CD,
                    MR_PROC_STEP_DET_CL_CD,
                    RV_REQ_CTT,
                    REQ_DT,
                    END_DT,
                    PROC_TRM_CL_CD,
                    FST_PROC_TRM_DT,
                    SCND_PROC_TRM_DT,
                    THRD_PROC_TRM_DT,
                    DEL_YN,
                    FST_RGST_DT,
                    FST_RGSTR,
                    LAST_CHG_DT,
                    LAST_CHGR
             ) VALUES ( #{mrReqProcStepDetNo},
                        #{mrReqProcStepNo},
                        #{mrReqNo},
                        #{mrStepCd},
                        #{procStCd},
                        #{jobRvCd},
                        #{mrProcStepDetClCd},
                        #{rvReqCtt},
                        #{reqDt},
                        #{endDt},
                        #{procTrmClCd},
                        #{fstProcTrmDt},
                        #{scndProcTrmDt},
                        #{thrdProcTrmDt},
                        0,
                        SYSDATE,
                        #{loginEmpNo},
                        SYSDATE,
                        #{loginEmpNo} )
    </insert>
    
    
    
    <insert id="updateMrReqProcStepDet" parameterType="com.mr.step.domain.MrReqProcStepDetVO">    
        --updateMrReqProcStepDet(step det 입력)
        UPDATE MR_REQ_PROC_STEP_DET SET 
                    PROC_TRM_CL_CD = #{procTrmClCd},
                    FST_PROC_TRM_DT = #{fstProcTrmDt},
                    SCND_PROC_TRM_DT = #{scndProcTrmDt},
                    THRD_PROC_TRM_DT = #{thrdProcTrmDt},
                    FST_RGST_DT = SYSDATE,
                    FST_RGSTR = #{loginEmpNo},
                    LAST_CHG_DT = SYSDATE,
                    LAST_CHGR = #{loginEmpNo}
                    WHERE MR_REQ_PROC_STEP_DET_NO = #{mrReqProcStepDetNo}
    </insert>
    
    
    <insert id="insertMrReqProcStepDetDev" parameterType="com.mr.step.domain.MrReqProcStepDetVO">
    <selectKey keyProperty="mrReqProcStepDetNo" resultType="int" order="BEFORE">
            SELECT MR_REQ_PROC_STEP_DET_SEQ.NEXTVAL
              FROM DUAL
        </selectKey>     
        --insertMrReqProcStepDet(step det 입력 2)
        INSERT INTO MR_REQ_PROC_STEP_DET (
                    MR_REQ_PROC_STEP_DET_NO,
                    MR_REQ_PROC_STEP_NO,
                    MR_REQ_NO,
                    MR_STEP_CD,
                    PROC_ST_CD,
                    JOB_RV_CD,
                    MR_PROC_STEP_DET_CL_CD,
                    RV_REQ_CTT,
                    REQ_DT,
                    END_DT,
                    PROC_TRM_CL_CD,
                    FST_PROC_TRM_DT,
                    SCND_PROC_TRM_DT,
                    THRD_PROC_TRM_DT,
                    DEL_YN,
                    FST_RGST_DT,
                    FST_RGSTR,
                    LAST_CHG_DT,
                    LAST_CHGR
             ) VALUES ( #{mrReqProcStepDetNo},
                        #{mrReqProcStepNo},
                        #{mrReqNo},
                        #{mrStepCd},
                        #{procStCd},
                        #{jobRvCd},
                        #{mrProcStepDetClCd},
                        #{rvReqCtt},
                        #{reqDt},
                        #{endDt},
                        #{procTrmClCd},
                        SYSDATE + 7,
                        #{scndProcTrmDt},
                        #{thrdProcTrmDt},
                        0,
                        SYSDATE,
                        #{loginEmpNo},
                        SYSDATE,
                        #{loginEmpNo} )
    </insert>

       <insert id="insertMrReqProcStepDetForStepLast" parameterType="com.mr.step.domain.MrReqProcStepDetVO">
       <selectKey keyProperty="mrReqProcStepDetNo" resultType="int" order="BEFORE">
            SELECT MR_REQ_PROC_STEP_DET_SEQ.NEXTVAL
              FROM DUAL
        </selectKey>    
        INSERT INTO MR_REQ_PROC_STEP_DET (
                    MR_REQ_PROC_STEP_DET_NO,
                    MR_REQ_PROC_STEP_NO,
                    MR_REQ_NO,
                    MR_STEP_CD,
                    PROC_ST_CD,
                    JOB_RV_CD,
                    MR_PROC_STEP_DET_CL_CD,
                    RV_REQ_CTT,
                    REQ_DT,
                    END_DT,
                    PROC_TRM_CL_CD,
                    FST_PROC_TRM_DT,
                    SCND_PROC_TRM_DT,
                    THRD_PROC_TRM_DT,
                    DEL_YN,
                    FST_RGST_DT,
                    FST_RGSTR,
                    LAST_CHG_DT,
                    LAST_CHGR
             ) VALUES ( #{mrReqProcStepDetNo},
                        (SELECT MAX(MR_REQ_PROC_STEP_NO)
                           FROM MR_REQ_PROC_STEP
                          WHERE MR_REQ_NO=#{mrReqNo}
                            AND EFF_END_DTM = '99991231235959'
                            AND DEL_YN=0),
                        #{mrReqNo},
                        #{mrStepCd},
                        #{procStCd},
                        #{jobRvCd},
                        #{mrProcStepDetClCd},
                        #{rvReqCtt},
                        #{reqDt},
                        #{endDt},
                        #{procTrmClCd},
                        #{fstProcTrmDt},
                        <!--  TRUNC(SYSDATE + 7),-->
                        #{scndProcTrmDt},
                        #{thrdProcTrmDt},
                        0,
                        SYSDATE,
                        #{loginEmpNo},
                        SYSDATE,
                        #{loginEmpNo} )
    </insert>


    <update id="updateMrReqProcStepDetDelYn" parameterType="map">
    --updateMrReqProcStepDetDelYn(상세스텝논리삭제)
        UPDATE MR_REQ_PROC_STEP_DET
           SET DEL_YN = 1,
               LAST_CHG_DT = SYSDATE,
               LAST_CHGR = #{loginEmpNo}
         WHERE MR_REQ_NO = #{mrReqNo}
           AND MR_STEP_CD = #{mrStepCd}
           AND DEL_YN=0
    </update>
    
    <update id="updateDetHistDelDuplication" parameterType="map">
    -- rvRst-Sql.updateDetHistDelDuplication
    <!-- yoo 240910 중복 제거 추가 담당자가 중복으로 많으면 표시가 안됨-->
		UPDATE MR_REQ_PROC_STEP_DET SET DEL_YN = 1 ,LAST_CHG_DT = SYSDATE ,LAST_CHGR = #{loginEmpNo} WHERE MR_REQ_PROC_STEP_DET_NO IN(
		SELECT DET.MR_REQ_PROC_STEP_DET_NO FROM MR_REQ_PROC_STEP STEP, MR_REQ_PROC_STEP_DET DET,
		MR_REQ_CHRGR_CHG_HIST HIST, EDM_EMP EMP, EDM_ORG TEAM, EDM_DUTY DUTY WHERE STEP.MR_REQ_PROC_STEP_NO = DET.MR_REQ_PROC_STEP_NO AND DET.MR_REQ_PROC_STEP_DET_NO = HIST.MR_REQ_PROC_STEP_DET_NO
		AND HIST.CHRG_EMP_NO = EMP.EMP_ID AND HIST.CHRG_TEAM_NO = TEAM.ORG_ID(+) AND EMP.DUTY_ID = DUTY.DUTY_ID AND STEP.MR_REQ_NO = #{mrReqNo} AND DET.MR_STEP_CD = #{mrStepCd}
		AND HIST.CHRGR_CL_CD NOT LIKE 'Z02H%' 
		AND HIST.EFF_END_DTM = '99991231235959' 
		AND HIST.DEL_YN=0 AND DET.DEL_YN=0 AND STEP.DEL_YN=0 
		AND LENGTH(HIST.CHRGR_CL_CD) = 4
		MINUS
		SELECT MAX(DET.MR_REQ_PROC_STEP_DET_NO) AS MR_REQ_PROC_STEP_DET_NO
		FROM MR_REQ_PROC_STEP STEP, MR_REQ_PROC_STEP_DET DET,
		MR_REQ_CHRGR_CHG_HIST HIST, EDM_EMP EMP, EDM_ORG TEAM, EDM_DUTY DUTY 
		WHERE STEP.MR_REQ_PROC_STEP_NO = DET.MR_REQ_PROC_STEP_NO AND DET.MR_REQ_PROC_STEP_DET_NO = HIST.MR_REQ_PROC_STEP_DET_NO
		AND HIST.CHRG_EMP_NO = EMP.EMP_ID AND HIST.CHRG_TEAM_NO = TEAM.ORG_ID(+) AND EMP.DUTY_ID = DUTY.DUTY_ID AND STEP.MR_REQ_NO = #{mrReqNo} AND DET.MR_STEP_CD = #{mrStepCd}
		AND HIST.CHRGR_CL_CD NOT LIKE 'Z02H%' 
		AND HIST.EFF_END_DTM = '99991231235959' 
		AND HIST.DEL_YN=0 AND DET.DEL_YN=0 AND STEP.DEL_YN=0 
		AND LENGTH(HIST.CHRGR_CL_CD) = 4
		GROUP BY HIST.CHRGR_CL_CD) 
    </update>

	<update id="updateDetHistDelDuplication2" parameterType="map">
	-- rvRst-Sql.updateDetHistDelDuplication2
    <!-- yoo 240910 중복 제거 추가 담당자가 중복으로 많으면 표시가 안됨-->
		UPDATE MR_REQ_CHRGR_CHG_HIST SET DEL_YN = 1 ,LAST_CHG_DT = SYSDATE ,LAST_CHGR = #{loginEmpNo} WHERE MR_REQ_PROC_STEP_DET_NO IN(
		SELECT DET.MR_REQ_PROC_STEP_DET_NO FROM MR_REQ_PROC_STEP STEP, MR_REQ_PROC_STEP_DET DET,
		MR_REQ_CHRGR_CHG_HIST HIST, EDM_EMP EMP, EDM_ORG TEAM, EDM_DUTY DUTY WHERE STEP.MR_REQ_PROC_STEP_NO = DET.MR_REQ_PROC_STEP_NO AND DET.MR_REQ_PROC_STEP_DET_NO = HIST.MR_REQ_PROC_STEP_DET_NO
		AND HIST.CHRG_EMP_NO = EMP.EMP_ID AND HIST.CHRG_TEAM_NO = TEAM.ORG_ID(+) AND EMP.DUTY_ID = DUTY.DUTY_ID AND STEP.MR_REQ_NO = #{mrReqNo} AND DET.MR_STEP_CD = #{mrStepCd}
		AND HIST.CHRGR_CL_CD NOT LIKE 'Z02H%' 
		AND HIST.EFF_END_DTM = '99991231235959' 
		AND HIST.DEL_YN=0 AND STEP.DEL_YN=0 
		AND LENGTH(HIST.CHRGR_CL_CD) = 4
		MINUS
		SELECT MAX(DET.MR_REQ_PROC_STEP_DET_NO) AS MR_REQ_PROC_STEP_DET_NO
		FROM MR_REQ_PROC_STEP STEP, MR_REQ_PROC_STEP_DET DET,
		MR_REQ_CHRGR_CHG_HIST HIST, EDM_EMP EMP, EDM_ORG TEAM, EDM_DUTY DUTY 
		WHERE STEP.MR_REQ_PROC_STEP_NO = DET.MR_REQ_PROC_STEP_NO AND DET.MR_REQ_PROC_STEP_DET_NO = HIST.MR_REQ_PROC_STEP_DET_NO
		AND HIST.CHRG_EMP_NO = EMP.EMP_ID AND HIST.CHRG_TEAM_NO = TEAM.ORG_ID(+) AND EMP.DUTY_ID = DUTY.DUTY_ID AND STEP.MR_REQ_NO = #{mrReqNo} AND DET.MR_STEP_CD = #{mrStepCd}
		AND HIST.CHRGR_CL_CD NOT LIKE 'Z02H%' 
		AND HIST.EFF_END_DTM = '99991231235959' 
		AND HIST.DEL_YN=0 AND STEP.DEL_YN=0 
		AND LENGTH(HIST.CHRGR_CL_CD) = 4
		GROUP BY HIST.CHRGR_CL_CD)
    </update>
    
    <update id="updateMrReqProcStepDetJobRvCd" parameterType="map">    
        UPDATE MR_REQ_PROC_STEP_DET
           SET JOB_RV_CD = #{jobRvCd},
               LAST_CHG_DT = SYSDATE,
             <!--   FST_PROC_TRM_DT = null, 20230926 원복 hsw -->
               LAST_CHGR = #{loginEmpNo}
         WHERE MR_REQ_PROC_STEP_DET_NO = #{mrReqProcStepDetNo}
           AND DEL_YN=0
    </update>

    <update id="updateMrReqProcStepDetProcTrmDt" parameterType="map">
        UPDATE MR_REQ_PROC_STEP_DET
           SET FST_PROC_TRM_DT = #{fstProcTrmDt},
               LAST_CHG_DT = SYSDATE,
               LAST_CHGR = #{loginEmpNo}
         WHERE MR_REQ_PROC_STEP_DET_NO = #{mrReqProcStepDetNo}
           AND DEL_YN=0
    </update>

    <update id="updatePorcStepDetDelYn" parameterType="map">
        UPDATE MR_REQ_PROC_STEP_DET
           SET DEL_YN = 1,
               LAST_CHG_DT = SYSDATE,
               LAST_CHGR = #{loginEmpNo}
         WHERE MR_REQ_PROC_STEP_DET_NO IN
        (SELECT DET.MR_REQ_PROC_STEP_DET_NO
           FROM MR_REQ_PROC_STEP_DET DET,
                MR_REQ_CHRGR_CHG_HIST HIST
          WHERE DET.MR_REQ_PROC_STEP_DET_NO = HIST.MR_REQ_PROC_STEP_DET_NO
            AND DET.MR_REQ_NO = #{mrReqNo}
            AND DET.MR_STEP_CD = #{mrStepCd}
            AND HIST.CHRGR_CL_CD LIKE 'Z02L%'
            AND DET.DEL_YN=0)

    </update>
    
    <update id="updatePorcStepDetNoDelYn" parameterType="map">
        UPDATE MR_REQ_PROC_STEP_DET
           SET DEL_YN = 1,
               LAST_CHG_DT = SYSDATE,
               LAST_CHGR = #{loginEmpNo}
         WHERE MR_REQ_PROC_STEP_DET_NO = #{mrReqProcStepDetNo}
           AND DEL_YN=0
    </update>
        

    <!-- 상신 -->
     <update id="updateMrIfStat" parameterType="map">
      UPDATE MR_REQ_CHRGR_CHG_HIST
	     SET IF_NAME    = '',
	         IF_STAT_CD = '',
	         IF_STAT_NM = ''
	   WHERE MR_REQ_PROC_STEP_DET_NO = #{mrReqProcStepDetNo}
    </update>
    
    <!-- 승인 반려 -->
    <update id="updateMrIfStat01" parameterType="map">
      UPDATE MR_REQ_CHRGR_CHG_HIST
         SET IF_NAME    = #{connIfName}
           , IF_STAT_CD = #{connIfStatGubun}
           , IF_STAT_NM = DECODE(#{connIfStatGubun}, '01', '성공','02', '실패' ) 
       WHERE MR_REQ_PROC_STEP_DET_NO = #{mrReqProcStepDetNo}
    </update>


    <!-- 상신 복사 
     <update id="updateMrIfStat" parameterType="map">
      UPDATE MR_REQ_CHRGR_CHG_HIST
	     SET IF_NAME = ''
	   WHERE MR_REQ_PROC_STEP_DET_NO = #{mrReqProcStepDetNo}
	     AND MR_REQ_NO   = #{connkey}
	     AND CHRGR_CL_CD = 'Z02A'
	     AND EFF_END_DTM &lt;&gt; '99991231235959' 
    </update>
     
      승인 반려 복사 
    <update id="updateMrIfStat01" parameterType="map">
      UPDATE MR_REQ_CHRGR_CHG_HIST
         SET IF_NAME    = #{connIfName}
           , IF_STAT_CD = #{connIfStatGubun}
           , IF_STAT_NM = DECODE(#{connIfStatGubun}, '01', '성공','02', '실패' ) 
       WHERE MR_REQ_PROC_STEP_DET_NO = #{mrReqProcStepDetNo}
	     AND MR_REQ_NO   = #{connkey}
         AND CHRG_EMP_NO = #{uid}
         AND CHRGR_CL_CD = 'Z02A'
         AND EFF_END_DTM = '99991231235959'
    </update>
    -->    
    
</mapper>