<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mr.comp">

    <resultMap id="compFileMap" type="com.mr.comp.domain.CompFileVO">
        <id property="mrReqNo" column="MR_REQ_NO" />
        <result property="mrReqTitle" column="MR_REQ_TITLE" />
        <result property="mrNo" column="MR_NO" />
        <result property="mrTmpNo" column="MR_TMP_NO" />
        <result property="mrStepCd" column="MR_STEP_CD" />
        <result property="procStCd" column="PROC_ST_CD" />
        <result property="plant" column="PLANT" />
        <result property="plantNm" column="PLANT_NM" />
        <result property="reqClCd" column="REQ_CL_CD" />
        <result property="reqClDtlCd" column="REQ_CL_DTL_CD" />
        <result property="workPsblClCd" column="WORK_PSBL_CL_CD" />
        <result property="workPsblClNm" column="WORK_PSBL_CL_NM" />
        <result property="workPsblDt" column="WORK_PSBL_DT" />
        <result property="workPsblClRsn" column="WORK_PSBL_CL_RSN" />
        <result property="rigionCd" column="RIGION_CD" />
        <result property="issueCtt" column="ISSUE_CTT" />
        <result property="inflnceLoss" column="INFLNCE_LOSS" />
        <result property="incnvCtt" column="INCNV_CTT" />
        <result property="useCnt" column="USE_CNT" />
        <result property="useCntPrd" column="USE_CNT_PRD" />
        <result property="imprvPrpslCtt" column="IMPRV_PRPSL_CTT" />
        <result property="qualEptEftCtt" column="QUAL_EPT_EFT_CTT" />
        <result property="quanEptEftCtt" column="QUAN_EPT_EFT_CTT" />
        <result property="quanEptEftCd" column="QUAN_EPT_EFT_CD" />
        <result property="cnclEmpNo" column="CNCL_EMP_ID" />
        <result property="cnclDt" column="CNCL_DT" />
        <result property="cnclRsnCtt" column="CNCL_RSN_CTT" />
        <result property="safetyChkDt" column="SAFETY_CHK_DT" />
        <result property="safetyChkLoc" column="SAFETY_CHK_LOC" />
        <result property="invstCostNo" column="INVST_COST_NO" />
        <result property="capexNo" column="CAPEX_NO" />
        <result property="delYn" column="DEL_YN" />
        <result property="fstRgstDt" column="FST_RGST_DT" />
        <result property="fstRgstr" column="FST_RGSTR" />
        <result property="lastChgDt" column="LAST_CHG_DT" />
        <result property="lastChgr" column="LAST_CHGR" />
        <result property="invstCd" column="INVST_CD" />
        <result property="invstPurpCd" column="INVST_PURP_CD" />
        <result property="invstCdNm" column="INVST_CD_NM" />
        <result property="invstPurpCdNm" column="INVST_PURP_CD_NM" />
        <result property="chrgrDiv" column="CHRGR_DIV" />
        <collection property="appLine" ofType="com.mr.comp.domain.CompChrgrChgHistVO" column="{mrReqNo=MR_REQ_NO, mrStepCd=MR_STEP_CD} " select="selectCompLine" />
        <collection property="rvRsts" ofType="com.mr.common.domain.MrRvRstVO" column="{mrReqNo=MR_REQ_NO, itemCd=ITEM_CD_LIKE" select="mr.rvRst.selectMrRvRst" />
    </resultMap>
    <select id="selectCompFile" resultMap="compFileMap">
    	--selectCompFile (자료등록관리 MR 마스터 조회)
         SELECT A.MR_REQ_NO,
                A.MR_REQ_TITLE,
                A.MR_NO,
                A.MR_TMP_NO,
                A.MR_STEP_CD,
                A.PROC_ST_CD,
                A.PLANT,
                'ATCH' AS ITEM_CD_LIKE,
                (SELECT MR_COMM_NM FROM MR_COMM_COD WHERE MR_COMM_GRP_CD='PLANT' AND MR_COMM_CD=A.PLANT) PLANT_NM,
                A.REQ_CL_CD,
                A.REQ_CL_DTL_CD,
                A.WORK_PSBL_CL_CD,
                (SELECT MR_COMM_NM FROM MR_COMM_COD WHERE MR_COMM_GRP_CD='WORK' AND MR_COMM_CD=A.WORK_PSBL_CL_CD) WORK_PSBL_CL_NM,
                A.WORK_PSBL_DT,
                A.WORK_PSBL_CL_RSN,
                A.RIGION_CD,
                A.ISSUE_CTT,
                A.INFLNCE_LOSS,
                A.INCNV_CTT,
                A.USE_CNT,
                A.USE_CNT_PRD,
                A.IMPRV_PRPSL_CTT,
                A.QUAL_EPT_EFT_CTT,
                A.QUAN_EPT_EFT_CTT,
                A.QUAN_EPT_EFT_CD,
                A.CNCL_EMP_ID,
                A.CNCL_DT,
                A.CNCL_RSN_CTT,
                A.SAFETY_CHK_DT,
                A.SAFETY_CHK_LOC,
                A.INVST_COST_NO,
                A.CAPEX_NO,
                A.DEL_YN,
                A.FST_RGST_DT,
                A.FST_RGSTR,
                A.LAST_CHG_DT,
                A.LAST_CHGR,
                B.INVST_CD,
                B.INVST_PURP_CD,
                (SELECT MR_COMM_NM FROM MR_COMM_COD WHERE MR_COMM_GRP_CD='IVST' AND MR_COMM_CD=B.INVST_CD) INVST_CD_NM,
                (SELECT MR_COMM_NM FROM MR_COMM_COD WHERE MR_COMM_GRP_CD='IVST_PUR' AND MR_COMM_CD=B.INVST_CD) INVST_PURP_CD_NM,
                (SELECT CHRGR_CL_CD FROM MR_REQ_CHRGR_CHG_HIST WHERE MR_REQ_PROC_STEP_DET_NO =
                (SELECT MIN(MR_REQ_PROC_STEP_DET_NO) FROM MR_REQ_PROC_STEP_DET WHERE MR_REQ_NO=#{mrReqNo} AND MR_STEP_CD='Z0080' AND PROC_ST_CD='Z0110')) CHRGR_DIV
           FROM MR_REQ_MST A, MR_TECH_RV B
          WHERE A.MR_REQ_NO = B.MR_REQ_NO(+)
            AND A.MR_REQ_NO = #{mrReqNo}
            AND A.DEL_YN=0
            AND B.DEL_YN=0
            and b.STEP_TYPE is null   /*mr수행 위험성 검토 때문에 추가*/
    </select>

    <resultMap id="compFileManageMap" type="com.mr.comp.domain.CompFileManageVO">
        <id property="mrAtchFileNo" column="MR_ATCH_FILE_NO" />
        <result property="mrReqProcStepDetNo" column="MR_REQ_PROC_STEP_DET_NO" />
        <result property="mrReqNo" column="MR_REQ_NO" />
        <result property="fileCd" column="FILE_CD" />
        <result property="fileNm" column="FILE_NM" />
        <result property="fileStepCd" column="FILE_STEP_CD" />
        <result property="fileStepNm" column="FILE_STEP_NM" />
        <result property="drawMngNo" column="DRAW_MNG_NO" />
        <result property="fileProcCd" column="FILE_PROC_CD" />
        <result property="delYn" column="DEL_YN" />
        <result property="mrStepCd" column="MR_STEP_CD" />
        <result property="procStCd" column="PROC_ST_CD" />
        <result property="fileCdNm" column="FILE_CD_NM" />
        <result property="mrStepCdNm" column="MR_STEP_CD_NM" />
        <result property="fstRgstDt" column="FST_RGST_DT" />
        <result property="fstRgstr" column="FST_RGSTR" />
        <result property="lastChgDt" column="LAST_CHG_DT" />
        <result property="lastChgr" column="LAST_CHGR" />
    </resultMap>
    <select id="selectCompFileManage" resultMap="compFileManageMap">
    	--selectCompFileManage (자료등록관리 조회)
         SELECT A.MR_ATCH_FILE_NO,
                A.MR_REQ_PROC_STEP_DET_NO,
                A.MR_REQ_NO,
                A.FILE_CD,
                A.FILE_NM,
                A.FILE_STEP_CD,
                (SELECT MR_COMM_NM FROM MR_COMM_COD WHERE MR_COMM_GRP_CD='MR_FILE' AND MR_COMM_CD=A.FILE_STEP_CD) FILE_STEP_NM,
                A.DRAW_MNG_NO,
                A.FILE_PROC_CD,
                A.DEL_YN,
                (SELECT MR_STEP_CD FROM MR_REQ_PROC_STEP_DET WHERE MR_REQ_PROC_STEP_DET_NO=A.MR_REQ_PROC_STEP_DET_NO) MR_STEP_CD,
                (SELECT PROC_ST_CD FROM MR_REQ_PROC_STEP_DET WHERE MR_REQ_PROC_STEP_DET_NO=A.MR_REQ_PROC_STEP_DET_NO) PROC_ST_CD,
                (SELECT MR_COMM_NM FROM MR_COMM_COD WHERE MR_COMM_GRP_CD='ATCH' AND MR_COMM_CD=A.FILE_CD) FILE_CD_NM,
                (SELECT MR_COMM_NM FROM MR_COMM_COD WHERE MR_COMM_GRP_CD='MR_PROC' AND MR_COMM_CD=(SELECT DECODE(MR_STEP_CD,'Z00H0','Z00R0',MR_STEP_CD) FROM MR_REQ_PROC_STEP_DET WHERE MR_REQ_PROC_STEP_DET_NO=A.MR_REQ_PROC_STEP_DET_NO)) MR_STEP_CD_NM,
                A.FST_RGST_DT,
                A.FST_RGSTR,
                A.LAST_CHG_DT,
                A.LAST_CHGR
           FROM MR_ATCH_FILE A
          WHERE A.MR_REQ_NO = #{mrReqNo}
            AND A.DEL_YN=0
            and a.STEP_TYPE is null    /*2025.11.03 IJS MR수행용 제외처리 */
       ORDER BY A.FILE_CD,MR_STEP_CD
    </select>
    
    <select id="selectCompCheckCount" resultType="int">
    	--selectCompCheckCount (자료등록 체크 리스트 개수)
         SELECT COUNT(*) AS CNT FROM MR_RV_RST WHERE MR_REQ_NO = #{mrReqNo} AND ITEM_CD LIKE 'ATCH%'
			UNION ALL
		 SELECT COUNT(*) AS CNT FROM MR_RV_RST WHERE MR_REQ_NO = #{mrReqNo} AND ITEM_CD LIKE 'ATCH%' AND (CL_CD_01 IS NULL OR CL_CD_02 IS NULL OR (CL_CD_02 = 2 AND CL_CD_01 = 1))
    </select>

    <resultMap id="compFileChrgrChgHistMap" type="com.mr.comp.domain.CompChrgrChgHistVO">
        <id property="mrReqProcStepDetNo" column="MR_REQ_PROC_STEP_DET_NO" />
        <result property="mrReqProcStepNo" column="MR_REQ_PROC_STEP_NO" />
        <result property="chrgrClCd" column="CHRGR_CL_CD" />
        <result property="effEndDtm" column="EFF_END_DTM" />
        <result property="effStaDtm" column="EFF_STA_DTM" />
        <result property="mrStepCd" column="MR_STEP_CD" />
        <result property="procStCd" column="PROC_ST_CD" />
        <result property="fstProcTrmDt" column="FST_PROC_TRM_DT" />
        <result property="mrReqNo" column="MR_REQ_NO" />
        <result property="chrgTeamNo" column="CHRG_TEAM_NO" />
        <result property="chrgEmpNo" column="CHRG_EMP_NO" />
        <result property="chrgEmpName" column="CHRG_EMP_NAME" />
        <result property="empEmail" column="EMP_EMAIL" />
        <result property="aprvChgYn" column="APRV_CHG_YN" />
        <result property="thdayTeam" column="THDAY_TEAM" />
        <result property="thdayPos" column="THDAY_POS" />
        <result property="sugg" column="SUGG" />
        <result property="delYn" column="DEL_YN" />
        <result property="fstRgstDt" column="FST_RGST_DT" />
        <result property="fstRgstr" column="FST_RGSTR" />
        <result property="lastChgDt" column="LAST_CHG_DT" />
        <result property="lastChgr" column="LAST_CHGR" />
    </resultMap>

    <select id="selectCompLine" resultMap="compFileChrgrChgHistMap">
    --자료등록관리 기술문서고 담당자 조회  , yoo 240923 담당자 겸임 처리를 위해 Z02D를 맨 뒤로 이동 시키기 위해 Union all사용
        SELECT DET.MR_REQ_NO,
               DET.MR_REQ_PROC_STEP_NO,
               DET.MR_REQ_PROC_STEP_DET_NO,
               HIST.CHRGR_CL_CD,
               HIST.PROC_ST_CD,
               DECODE(THDAY_POS, NULL, DUTY_NAME, THDAY_POS) AS THDAY_POS,
               EMP.EMP_NAME AS CHRG_EMP_NAME,
               EMP.EMP_EMAIL AS EMP_EMAIL,
               HIST.CHRG_EMP_NO AS CHRG_EMP_NO,
               DECODE(THDAY_TEAM, NULL, ORG_NAME, THDAY_TEAM) AS THDAY_TEAM,
               HIST.CHRG_TEAM_NO AS CHRG_TEAM_NO,
               DET.FST_PROC_TRM_DT,
               DECODE(DET.FST_PROC_TRM_DT, NULL, HIST.LAST_CHG_DT, '') AS LAST_CHG_DT
          FROM MR_REQ_PROC_STEP STEP,
               MR_REQ_PROC_STEP_DET DET,
               MR_REQ_CHRGR_CHG_HIST HIST,
               EDM_EMP EMP,
               EDM_ORG TEAM,
               EDM_DUTY DUTY
         WHERE STEP.MR_REQ_PROC_STEP_NO = DET.MR_REQ_PROC_STEP_NO
           AND DET.MR_REQ_PROC_STEP_DET_NO = HIST.MR_REQ_PROC_STEP_DET_NO
           AND HIST.CHRG_EMP_NO = EMP.EMP_ID
           AND HIST.CHRG_TEAM_NO = TEAM.ORG_ID(+)
           AND EMP.DUTY_ID = DUTY.DUTY_ID
           AND STEP.MR_REQ_NO = #{mrReqNo}
           AND DET.MR_REQ_PROC_STEP_DET_NO IN (SELECT MAX(MR_REQ_PROC_STEP_DET_NO) AS MR_REQ_PROC_STEP_DET_NO FROM MR_REQ_CHRGR_CHG_HIST WHERE MR_REQ_NO =  #{mrReqNo} AND CHRGR_CL_CD IN ('Z02D') GROUP BY CHRGR_CL_CD)
           /* AND DET.MR_STEP_CD = 'Z0080' yoo 240529 요청자, 기술검토자, 프로젝트 엔지니어 추가
           AND HIST.CHRGR_CL_CD = 'Z02Q'
           AND HIST.EFF_END_DTM = '99991231235959' */
           AND HIST.DEL_YN=0
           AND DET.DEL_YN=0
           AND STEP.DEL_YN=0
           UNION ALL
           SELECT DET.MR_REQ_NO,
               DET.MR_REQ_PROC_STEP_NO,
               DET.MR_REQ_PROC_STEP_DET_NO,
               HIST.CHRGR_CL_CD,
               HIST.PROC_ST_CD,
               DECODE(THDAY_POS, NULL, DUTY_NAME, THDAY_POS) AS THDAY_POS,
               EMP.EMP_NAME AS CHRG_EMP_NAME,
               EMP.EMP_EMAIL AS EMP_EMAIL,
               HIST.CHRG_EMP_NO AS CHRG_EMP_NO,
               DECODE(THDAY_TEAM, NULL, ORG_NAME, THDAY_TEAM) AS THDAY_TEAM,
               HIST.CHRG_TEAM_NO AS CHRG_TEAM_NO,
               DET.FST_PROC_TRM_DT,
               DECODE(DET.FST_PROC_TRM_DT, NULL, HIST.LAST_CHG_DT, '') AS LAST_CHG_DT
          FROM MR_REQ_PROC_STEP STEP,
               MR_REQ_PROC_STEP_DET DET,
               MR_REQ_CHRGR_CHG_HIST HIST,
               EDM_EMP EMP,
               EDM_ORG TEAM,
               EDM_DUTY DUTY
         WHERE STEP.MR_REQ_PROC_STEP_NO = DET.MR_REQ_PROC_STEP_NO
           AND DET.MR_REQ_PROC_STEP_DET_NO = HIST.MR_REQ_PROC_STEP_DET_NO
           AND HIST.CHRG_EMP_NO = EMP.EMP_ID
           AND HIST.CHRG_TEAM_NO = TEAM.ORG_ID(+)
           AND EMP.DUTY_ID = DUTY.DUTY_ID
           AND STEP.MR_REQ_NO = #{mrReqNo}
           AND DET.MR_REQ_PROC_STEP_DET_NO IN (SELECT MAX(MR_REQ_PROC_STEP_DET_NO) AS MR_REQ_PROC_STEP_DET_NO FROM MR_REQ_CHRGR_CHG_HIST WHERE MR_REQ_NO =  #{mrReqNo} AND CHRGR_CL_CD IN ('Z02Q','Z02A','Z02I') GROUP BY CHRGR_CL_CD)
           /* AND DET.MR_STEP_CD = 'Z0080' yoo 240529 요청자, 기술검토자, 프로젝트 엔지니어 추가
           AND HIST.CHRGR_CL_CD = 'Z02Q'
           AND HIST.EFF_END_DTM = '99991231235959' */
           AND HIST.DEL_YN=0
           AND DET.DEL_YN=0
           AND STEP.DEL_YN=0
    </select>
    

    <resultMap id="countCompFileMap" type="com.mr.comp.domain.CompChrgrChgHistVO">
        <result property="checkCnt" column="CHECK_CNT" />
    </resultMap>

    <select id="countCompFile" resultMap="countCompFileMap">
    --countCompFile (자료등록관리 등록여부)
        SELECT COUNT(*) AS CHECK_CNT          FROM MR_REQ_CHRGR_CHG_HIST         WHERE MR_REQ_NO = #{mrReqNo}           AND CHRGR_CL_CD LIKE 'Z02Q%'           AND DEL_YN=0
           UNION ALL
           SELECT COUNT(*) AS CHECK_CNT FROM MR_RV_RST WHERE MR_REQ_NO = #{mrReqNo} AND ITEM_CD like 'ATCH%'
    </select>

       <insert id="insertCompFileProcStepDet" parameterType="com.mr.comp.domain.CompProcStepDetVO">
       <selectKey keyProperty="mrReqProcStepDetNo" resultType="int" order="BEFORE">
            SELECT MR_REQ_PROC_STEP_DET_SEQ.NEXTVAL
              FROM DUAL
        </selectKey>   
        INSERT INTO MR_REQ_PROC_STEP_DET (
                    MR_REQ_PROC_STEP_DET_NO,
                    MR_REQ_PROC_STEP_NO,
                    MR_REQ_NO,
                    MR_STEP_CD,
                    PROC_ST_CD,
                    JOB_RV_CD,
                    MR_PROC_STEP_DET_CL_CD,
                    RV_REQ_CTT,
                    REQ_DT,
                    END_DT,
                    PROC_TRM_CL_CD,
                    FST_PROC_TRM_DT,
                    SCND_PROC_TRM_DT,
                    THRD_PROC_TRM_DT,
                    DEL_YN,
                    FST_RGST_DT,
                    FST_RGSTR,
                    LAST_CHG_DT,
                    LAST_CHGR
             ) VALUES ( #{mrReqProcStepDetNo},
                        (SELECT MAX(MR_REQ_PROC_STEP_NO)
                           FROM MR_REQ_PROC_STEP
                          WHERE MR_REQ_NO=#{mrReqNo}
                            AND EFF_END_DTM = '99991231235959'
                            AND DEL_YN=0),
                        #{mrReqNo},
                        #{mrStepCd},
                        #{procStCd},
                        #{jobRvCd},
                        #{mrProcStepDetClCd},
                        #{rvReqCtt},
                        #{reqDt},
                        #{endDt},
                        #{procTrmClCd},
                        #{fstProcTrmDt},
                        #{scndProcTrmDt},
                        #{thrdProcTrmDt},
                        0,
                        SYSDATE,
                        #{loginEmpNo},
                        SYSDATE,
                        #{loginEmpNo} )
    </insert>

    <insert id="insertCompFileChrgrChgHist" parameterType="com.mr.comp.domain.CompChrgrChgHistVO">
        INSERT INTO MR_REQ_CHRGR_CHG_HIST (
                    MR_REQ_PROC_STEP_DET_NO,
                    CHRGR_CL_CD,
                    EFF_END_DTM,
                    EFF_STA_DTM,
                    MR_REQ_NO,
                    PROC_ST_CD,
                    CHRG_TEAM_NO,
                    CHRG_EMP_NO,
                    APRV_CHG_YN,
                    THDAY_TEAM,
                    THDAY_POS,
                    SUGG,
                    DEL_YN,
                    FST_RGST_DT,
                    FST_RGSTR,
                    LAST_CHG_DT,
                    LAST_CHGR
             ) VALUES ( #{mrReqProcStepDetNo},
                        #{chrgrClCd},
                        '99991231235959',
                        TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),
                        #{mrReqNo},
                        #{procStCd},
                        #{chrgTeamNo},
                        #{chrgEmpNo},
                        #{aprvChgYn},
                        #{thdayTeam},
                        #{thdayPos},
                        #{sugg},
                        0,
                        SYSDATE,
                        #{loginEmpNo},
                        SYSDATE,
                        #{loginEmpNo} )
    </insert>

    <update id="updateCompFileProcStepDet" parameterType="map">
    		--updateCompFileProcStepDet(자료등록관리 진행상세 저장(수정))
             UPDATE MR_REQ_PROC_STEP_DET
                SET FST_PROC_TRM_DT = #{fstProcTrmDt},
                    LAST_CHG_DT = SYSDATE,
                    LAST_CHGR = #{loginEmpNo}
              WHERE MR_REQ_PROC_STEP_DET_NO = ( SELECT MIN(MR_REQ_PROC_STEP_DET_NO) FROM MR_REQ_CHRGR_CHG_HIST
                                                WHERE MR_REQ_NO = #{mrReqNo}
                                                  AND CHRGR_CL_CD = #{chrgrClCd}
                                                  AND EFF_END_DTM = '99991231235959'
                                                  AND DEL_YN = '0'
                                               )
                AND MR_REQ_NO = #{mrReqNo}
                AND MR_STEP_CD = #{mrStepCd}
                AND PROC_ST_CD = #{procStCd}
                AND DEL_YN='0'
    </update>

    <update id="updateCompFileChrgrChgHist" parameterType="map">
    --updateCompFileChrgrChgHist (자료등록관리 담당자 저장(수정))
             UPDATE MR_REQ_CHRGR_CHG_HIST
                SET CHRG_TEAM_NO = #{chrgTeamNo},
                    CHRG_EMP_NO = #{chrgEmpNo},
                    THDAY_TEAM = #{thdayTeam},
                    THDAY_POS = #{thdayPos},
                    LAST_CHG_DT = SYSDATE,
                    LAST_CHGR = #{loginEmpNo}
              WHERE MR_REQ_NO = #{mrReqNo}
                AND CHRGR_CL_CD = #{chrgrClCd}
                AND EFF_END_DTM = '99991231235959'
                AND DEL_YN='0'
    </update>

    <update id="updateCompFileEffEnd" parameterType="map">
    -- updateCompFileEffEnd    
        UPDATE MR_REQ_CHRGR_CHG_HIST
           SET EFF_END_DTM = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS'),
               LAST_CHG_DT = SYSDATE,
               LAST_CHGR = #{loginEmpNo}
         WHERE MR_REQ_PROC_STEP_DET_NO IN
        (SELECT MR_REQ_PROC_STEP_DET_NO
           FROM MR_REQ_PROC_STEP_DET
          WHERE MR_REQ_NO = #{mrReqNo}
            AND MR_STEP_CD = #{mrStepCd}
            AND PROC_ST_CD = #{procStCd}
            AND EFF_END_DTM = '99991231235959'
            AND DEL_YN=0)
    </update>

    <resultMap id="countMrStepCompMap" type="com.mr.comp.domain.CompFileManageVO">
        <result property="fileCnt" column="FILE_CNT" />
    </resultMap>

    <select id="countMrStepComp" resultMap="countMrStepCompMap">
        SELECT COUNT(*) FILE_CNT
          FROM MR_ATCH_FILE
         WHERE MR_REQ_NO = #{mrReqNo}
           AND FILE_PROC_CD = '1'
           AND DEL_YN=0
    </select>

    <update id="requestCompFile" parameterType="map">
        UPDATE MR_ATCH_FILE
           SET FILE_PROC_CD = '1'
         WHERE MR_ATCH_FILE_NO = #{mrAtchFileNo}
           AND DEL_YN=0
    </update>

    <update id="updateCompFileComp" parameterType="map">
        UPDATE MR_REQ_CHRGR_CHG_HIST
           SET CHRGR_CL_CD='Z02D',
               CHRG_EMP_NO=(SELECT CHRG_EMP_NO FROM MR_REQ_CHRGR_CHG_HIST WHERE MR_REQ_PROC_STEP_DET_NO = (SELECT MAX(MR_REQ_PROC_STEP_DET_NO) FROM MR_REQ_CHRGR_CHG_HIST WHERE MR_REQ_NO=#{mrReqNo} AND CHRGR_CL_CD='Z02D')),
               CHRG_TEAM_NO=(SELECT CHRG_TEAM_NO FROM MR_REQ_CHRGR_CHG_HIST WHERE MR_REQ_PROC_STEP_DET_NO = (SELECT MAX(MR_REQ_PROC_STEP_DET_NO) FROM MR_REQ_CHRGR_CHG_HIST WHERE MR_REQ_NO=#{mrReqNo} AND CHRGR_CL_CD='Z02D')),
               THDAY_TEAM=(SELECT THDAY_TEAM FROM MR_REQ_CHRGR_CHG_HIST WHERE MR_REQ_PROC_STEP_DET_NO = (SELECT MAX(MR_REQ_PROC_STEP_DET_NO) FROM MR_REQ_CHRGR_CHG_HIST WHERE MR_REQ_NO=#{mrReqNo} AND CHRGR_CL_CD='Z02D')),
               THDAY_POS=(SELECT THDAY_POS FROM MR_REQ_CHRGR_CHG_HIST WHERE MR_REQ_PROC_STEP_DET_NO = (SELECT MAX(MR_REQ_PROC_STEP_DET_NO) FROM MR_REQ_CHRGR_CHG_HIST WHERE MR_REQ_NO=#{mrReqNo} AND CHRGR_CL_CD='Z02D')),
               LAST_CHG_DT = SYSDATE,
               LAST_CHGR = #{loginEmpNo}
         WHERE MR_REQ_PROC_STEP_DET_NO IN (SELECT B.MR_REQ_PROC_STEP_DET_NO FROM MR_REQ_PROC_STEP_DET A, MR_REQ_CHRGR_CHG_HIST B WHERE A.MR_REQ_PROC_STEP_DET_NO=B.MR_REQ_PROC_STEP_DET_NO AND A.MR_REQ_NO=#{mrReqNo} AND A.MR_STEP_CD IN ('Z0070','Z0080') AND B.CHRGR_CL_CD='Z02I')
    </update>

    <update id="updateMrStepComp" parameterType="map" statementType="CALLABLE">
        {call MR_FILE_MNG_APPROVE(#{mrNo},'9999','1',#{pRtnCode},#{pRtnMsg}) }
    </update>

</mapper>