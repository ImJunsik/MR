<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mr.jobs">
    <resultMap id="mrJobsMap" type="com.mr.jobs.domain.JobsReviewVO">
        <result property="mrReqNo" column="MR_REQ_NO" />
        <result property="mrNo" column="MR_NO" />
        <result property="mrReqTitle" column="MR_REQ_TITLE" />
        <result property="plant" column="PLANT" />
        <result property="plantNm" column="PLANT_NM" />
        <result property="reqClCd" column="REQ_CL_CD" />
        <result property="reqClCdNm" column="REQ_CL_CD_NM" />
        <result property="reqClDtlCd" column="REQ_CL_DTL_CD" />
        <result property="reqClDtlCdNm" column="REQ_CL_DTL_CD_NM" />
        <result property="workPsblClCd" column="WORK_PSBL_CL_CD" />
        <result property="workPsblClCdNm" column="WORK_PSBL_CL_CD_NM" />
        <result property="workPsblDt" column="WORK_PSBL_DT" />
        <result property="qualEptEftCtt" column="QUAL_EPT_EFT_CTT" />
        <result property="quanEptEftCtt" column="QUAN_EPT_EFT_CTT" />
        <result property="quanEptEftCd" column="QUAN_EPT_EFT_CD" />
        <result property="quanEptEftCdNm" column="QUAN_EPT_EFT_CD_NM" />
        <result property="hazopActYn" column="HAZOP_ACT_YN" />
        <result property="porcActYn" column="PORC_ACT_YN" />
        <result property="delYn" column="DEL_YN" />
        <result property="fstRgstDt" column="FST_RGST_DT" />
        <result property="fstRgstr" column="FST_RGSTR" />
        <result property="lastChgDt" column="LAST_CHG_DT" />
        <result property="lastChgr" column="LAST_CHGR" />
        <collection property="equips" ofType="com.mr.mrrq.domain.MrReqEquipVO" column="MR_REQ_NO" select="mr.mrReq.selectMrReqEquip" />
        <collection property="procs" ofType="com.mr.mrrq.domain.MrReqProcVO" column="MR_REQ_NO" select="mr.mrReq.selectMrReqProc" />
        <collection property="appLine" ofType="com.mr.step.domain.ChrgrChgHist" column="{mrReqNo=MR_REQ_NO, mrStepCd=MR_STEP_CD} " select="mr.step.selectJobLine" />
        <collection property="jobs" ofType="com.mr.step.domain.ChrgrChgHist" column="{mrReqNo=MR_REQ_NO, mrStepCd=MR_STEP_CD} " select="mr.step.selectAppLine" />
        <!-- <collection property="jobs" ofType="com.mr.step.domain.ChrgrChgHist" column="{mrReqNo=MR_REQ_NO, mrStepCd=MR_THCH_STEP_CD} " select="mr.step.selectJobLine" /> -->
    </resultMap>

    <select id="selectJobsReview" resultMap="mrJobsMap" parameterType="map">
    --직무검토 조회 setJobsComplete 확인
        SELECT MR.MR_NO,
               MR.MR_REQ_NO,
               MR.MR_REQ_TITLE,
               MR.PLANT,
               #{mrStepCd} AS MR_STEP_CD,
               PLANT.MR_COMM_NM AS PLANT_NM,
               MR.REQ_CL_CD,
               REQ_CD.MR_COMM_NM AS REQ_CL_CD_NM,
               MR.REQ_CL_DTL_CD,
               REQ_DTL_CD.MR_COMM_NM AS REQ_CL_DTL_CD_NM,
               MR.WORK_PSBL_CL_CD,
               WORK_CD.MR_COMM_NM AS WORK_PSBL_CL_CD_NM,
               MR.WORK_PSBL_DT,
               MR.QUAL_EPT_EFT_CTT,
               MR.QUAN_EPT_EFT_CTT,
               MR.QUAN_EPT_EFT_CD,
               MR.HAZOP_ACT_YN,
               MR.PORC_ACT_YN,
               QUAN_CD.MR_COMM_NM AS QUAN_EPT_EFT_CD_NM
          FROM MR_REQ_MST MR,
               (SELECT *
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'PLANT')PLANT,
               (SELECT *
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'REQ')REQ_CD,
               (SELECT *
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'REQ_DET')REQ_DTL_CD,
               (SELECT *
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'WORK')WORK_CD,
               (SELECT *
                  FROM MR_COMM_COD REQ_CD
                 WHERE MR_COMM_GRP_CD(+) = 'QN_UNIT')QUAN_CD
         WHERE MR.REQ_CL_CD = REQ_CD.MR_COMM_CD(+)
           AND MR.REQ_CL_DTL_CD = REQ_DTL_CD.MR_COMM_CD(+)
           AND MR.WORK_PSBL_CL_CD = WORK_CD.MR_COMM_CD(+)
           AND MR.QUAN_EPT_EFT_CD = QUAN_CD.MR_COMM_CD(+)
           AND MR.PLANT = PLANT.MR_COMM_CD(+)
           AND MR.MR_REQ_NO = #{mrReqNo}
           AND MR.DEL_YN=0
    </select>

    <resultMap id="mrJobsPorcMap" type="com.mr.jobs.domain.JobsPorcVO">
        <result property="mrReqNo" column="MR_REQ_NO" />
        <result property="mrNo" column="MR_NO" />
        <result property="porcNo" column="PORC_NO" />
        <result property="mrReqTitle" column="MR_REQ_TITLE"/>
        <result property="porcYn" column="PORC_YN" />
        <result property="plant" column="PLANT" />
        <collection property="appLine" ofType="com.mr.step.domain.ChrgrChgHist" column="{mrReqNo=MR_REQ_NO, mrStepCd=MR_STEP_CD} " select="mr.step.selectJobLine" />
        <collection property="drives" ofType="com.mr.step.domain.ChrgrChgHist" column="{mrReqNo=MR_REQ_NO, mrStepCd=MR_STEP_CD, chrgrClCd=Z02L1} " select="mr.step.selectAppLineRvRst" />
        <collection property="techs" ofType="com.mr.step.domain.ChrgrChgHist" column="{mrReqNo=MR_REQ_NO, mrStepCd=MR_STEP_CD, chrgrClCd=Z02L2} " select="mr.step.selectAppLineRvRst" />
        <collection property="builds" ofType="com.mr.step.domain.ChrgrChgHist" column="{mrReqNo=MR_REQ_NO, mrStepCd=MR_STEP_CD, chrgrClCd=Z02L3} " select="mr.step.selectAppLineRvRst" />
        <collection property="checks" ofType="com.mr.step.domain.ChrgrChgHist" column="{mrReqNo=MR_REQ_NO, mrStepCd=MR_STEP_CD, chrgrClCd=Z02L4} " select="mr.step.selectAppLineRvRst" />
        <collection property="safetys" ofType="com.mr.step.domain.ChrgrChgHist" column="{mrReqNo=MR_REQ_NO, mrStepCd=MR_STEP_CD, chrgrClCd=Z02L5} " select="mr.step.selectAppLineRvRst" />
        <collection property="etcs" ofType="com.mr.step.domain.ChrgrChgHist" column="{mrReqNo=MR_REQ_NO, mrStepCd=MR_STEP_CD, chrgrClCd=Z02L6} " select="mr.step.selectAppLineRvRst" />
    </resultMap>

    <select id="selectJobsPorc" resultMap="mrJobsPorcMap">
    --Porc위원회 조회
        SELECT MR.MR_REQ_NO,
               MR.MR_NO,
               MR.PORC_NO,
               MR.MR_REQ_TITLE,
               DECODE(PORC_NO, NULL ,'N','Y') PORC_YN,
               'Z00P0' AS MR_STEP_CD,
               'Z02L1' AS Z02L1,
               'Z02L2' AS Z02L2,
               'Z02L3' AS Z02L3,
               'Z02L4' AS Z02L4,
               'Z02L5' AS Z02L5,
               'Z02L6' AS Z02L6,
               PLANT
          FROM MR_REQ_MST MR
         WHERE MR.MR_REQ_NO = #{mrReqNo}
           AND DEL_YN=0
    </select>

    <select id="selectPorcDisagreeCount" resultType="int">
    --직무검토 반대여부조회(selectPorcDisagreeCount)
    SELECT NVL(COUNT(DECODE(CL_CD_01,2,1,NULL)),0) AS FALSE_CNT
      FROM MR_RV_RST
     WHERE MR_REQ_NO = #{mrReqNo}
       AND ITEM_CD = 'PORC'
       AND DEL_YN=0
    </select>

    <update id="updateMakePorcNo" parameterType="int">
             UPDATE MR_REQ_MST
                SET PORC_NO = ('PORC' || (SELECT TO_CHAR(SYSDATE,'YYYY') || RPAD('0',4,TO_NUMBER(NVL(SUBSTR(MAX(PORC_NO),-4),0))+1)
                               FROM MR_REQ_MST))
              WHERE MR_REQ_NO = #{mrReqNo}
                AND DEL_YN = 0
    </update>

    <!-- ========================================
         실행 HAZOP 관련 쿼리 (3개)
         ======================================== -->
    <resultMap id="mrRvRstMap" type="com.mr.common.domain.MrRvRstVO">
        <id property="mrRvRstNo" column= "MR_RV_RST_NO" />
        <result property="mrReqNo" column= "MR_REQ_NO" />
        <result property="mrNo" column= "MR_NO" />
        <result property="plant" column= "PLANT" />
        <result property="mrReqProcStepDetNo" column= "MR_REQ_PROC_STEP_DET_NO" />
        <result property="itemCd" column= "ITEM_CD" />
        <result property="clCd01" column= "CL_CD_01" />
        <result property="clCd02" column= "CL_CD_02" />
        <result property="clCd03" column= "CL_CD_03" />
        <result property="clCd04" column= "CL_CD_04" />
        <result property="clCd05" column= "CL_CD_05" />
        <result property="clCd06" column= "CL_CD_06" />
        <result property="clCd07" column= "CL_CD_07" />
        <result property="clCd08" column= "CL_CD_08" />
        <result property="clCd09" column= "CL_CD_09" />
        <result property="clCd10" column= "CL_CD_10" />
        <result property="clCd11" column= "CL_CD_11" />
        <result property="clCd12" column= "CL_CD_12" />
        <result property="clCd13" column= "CL_CD_13" />
        <result property="clCd14" column= "CL_CD_14" />
        <result property="clCd15" column= "CL_CD_15" />
        <result property="clCtt01" column= "CL_CTT_01" />
        <result property="clCtt02" column= "CL_CTT_02" />
        <result property="clCtt03" column= "CL_CTT_03" />
        <result property="clCtt04" column= "CL_CTT_04" />
        <result property="clCtt05" column= "CL_CTT_05" />
        <result property="clCtt06" column= "CL_CTT_06" />
        <result property="clCtt07" column= "CL_CTT_07" />
        <result property="clCtt08" column= "CL_CTT_08" />
        <result property="clCtt09" column= "CL_CTT_09" />
        <result property="clCtt10" column= "CL_CTT_10" />
        <result property="clCtt11" column= "CL_CTT_11" />
        <result property="clCtt12" column= "CL_CTT_12" />
        <result property="clCtt13" column= "CL_CTT_13" />
        <result property="clCtt14" column= "CL_CTT_14" />
        <result property="clCtt15" column= "CL_CTT_15" />
        <result property="clCmt01" column= "CL_CMT_01" />
        <result property="clCmt02" column= "CL_CMT_02" />
        <result property="clCmt03" column= "CL_CMT_03" />
        <result property="clCmt04" column= "CL_CMT_04" />
        <result property="clCmt05" column= "CL_CMT_05" />
        <result property="clCmt06" column= "CL_CMT_06" />
        <result property="clCmt07" column= "CL_CMT_07" />
        <result property="clCmt08" column= "CL_CMT_08" />
        <result property="clCmt09" column= "CL_CMT_09" />
        <result property="clCmt10" column= "CL_CMT_10" />
        <result property="clCmt11" column= "CL_CMT_11" />
        <result property="clCmt12" column= "CL_CMT_12" />
        <result property="clCmt13" column= "CL_CMT_13" />
        <result property="clCmt14" column= "CL_CMT_14" />
        <result property="clCmt15" column= "CL_CMT_15" />
        <result property="totRvSugg" column= "TOT_RV_SUGG" />
        <result property="delYn" column="DEL_YN" />
        <result property="fstRgstDt" column="FST_RGST_DT" />
        <result property="fstRgstr" column="FST_RGSTR" />
        <result property="lastChgDt" column="LAST_CHG_DT" />
        <result property="lastChgr" column="LAST_CHGR" />
        <!-- 2025-06-18 ijs 화면개선에 따른 컬럼 추가 @-->
        <result property="peName" column="PE_NAME" />
        <result property="peId" column="PE_ID" />
        <result property="peAddName" column="PE_ADD_NAME" />
        <result property="rgstId" column="RGST_ID" />
        <result property="rgstName" column="RGST_NAME" />
        <result property="confId" column="CONF_ID" />
        <result property="confName" column="CONF_NAME" />
        <result property="mrStepCd" column="MR_STEP_CD" />
		<result property="mrHazopYn" column="MR_HAZOP_YN" />
    </resultMap>

	<!--
	/*
	 수정 2017-05-11
     REPLACE(REPLACE(RST.TOT_RV_SUGG,CHR(10),'\N'),CHR(13),'\R') AS TOT_RV_SUGG,
     REPLACE( REPLACE(REPLACE(TOT_RV_SUGG,CHR(10),'\n'),CHR(13),'\r'),'''','') AS TOT_RV_SUGG, 따움표안보이게 처리됨
     REPLACE( REPLACE(REPLACE(TOT_RV_SUGG,CHR(10),'\n'),CHR(13),'\r'),'&#34','') AS TOT_RV_SUGG, 따움표안보이게 처리됨
     
         수정 2018-03-13
     REPLACE(REPLACE(REPLACE(TOT_RV_SUGG,CHR(10),'\n'),CHR(13),'\r'),'"','˝') AS TOT_RV_SUGG, 따움표보이게 (따움표를 특수문자 따움표로변경) 
	*/
	 -->
	<select id="selectMrRvRst" parameterType="com.mr.common.domain.MrRvRstVO" resultMap="mrRvRstMap">
    --selectMrRvRst MR수행 위험성 검토 00 (타당성검토 확인 page. 기술 및 타당성 검토 (경제성, 법규상제약, 기술적제약, 개선효과 미흡)
             SELECT RST.MR_RV_RST_NO,
                    MR_REQ.MR_REQ_NO,
                    MR_REQ.MR_NO,
                    MR_REQ.PLANT,
                    <choose>
					  <when test="stepCd == 'Z0060' and stepCd != ''">
					    #{stepCd} AS MR_STEP_CD,
					  </when>
					  <otherwise>
					    'Z00R0' AS MR_STEP_CD,
					  </otherwise>
					</choose>
					                    
                    RST.MR_REQ_PROC_STEP_DET_NO,
                    RST.ITEM_CD,
                    RST.CL_CD_01,
                    RST.CL_CD_02,
                    RST.CL_CD_03,
                    RST.CL_CD_04,
                    RST.CL_CD_05,
                    RST.CL_CD_06,
                    RST.CL_CD_07,
                    RST.CL_CD_08,
                    RST.CL_CD_09,
                    RST.CL_CD_10,
                    RST.CL_CD_11,
                    RST.CL_CD_12,
                    RST.CL_CD_13,
                    RST.CL_CD_14,
                    RST.CL_CD_15,
                    RST.CL_CTT_01,
                    RST.CL_CTT_02,
                    RST.CL_CTT_03,
                    RST.CL_CTT_04,
                    RST.CL_CTT_05,
                    RST.CL_CTT_06,
                    RST.CL_CTT_07,
                    RST.CL_CTT_08,
                    RST.CL_CTT_09,
                    RST.CL_CTT_10,
                    RST.CL_CTT_11,
                    RST.CL_CTT_12,
                    RST.CL_CTT_13,
                    RST.CL_CTT_14,
                    RST.CL_CTT_15,
                    RST.CL_CMT_01,
                    RST.CL_CMT_02,
                    RST.CL_CMT_03,
                    RST.CL_CMT_04,
                    RST.CL_CMT_05,
                    RST.CL_CMT_06,
                    RST.CL_CMT_07,
                    RST.CL_CMT_08,
                    RST.CL_CMT_09,
                    RST.CL_CMT_10,
                    RST.CL_CMT_11,
                    RST.CL_CMT_12,
                    RST.CL_CMT_13,
                    RST.CL_CMT_14,
                    RST.CL_CMT_15,
                    MR_REQ.HAZOP_ACT_YN,
                    MR_REQ.PORC_ACT_YN,
                    <!-- TOT_RV_SUGG, yoo 241106 홑따음표 , 개행 문자 처리를 위해 아래 처럼 변경 --> 
                    REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(RST.TOT_RV_SUGG,CHR(10),'\n'),CHR(13),'\r'),'"','˝'), CHR(34), '¶'), CHR(39),'¶') AS TOT_RV_SUGG, 
                    RST.DEL_YN,
                    RST.FST_RGST_DT,
                    RST.FST_RGSTR,
                    RST.LAST_CHG_DT,
                    RST.LAST_CHGR,
                    <!-- 2025-07-09 IJS 컬럼추가 -->
                    replace(replace(GETDEPTNAMEANEMPNAME(RST.PE_ID),'HDO_', ''),'HDC_', '') as PE_NAME,
				    RST.PE_ID,
				    RST.PE_ADD_NAME,
				    (SELECT
					    EMP.EMP_ID
					    /*, EMP.EMP_NAME*/
					FROM
					    mr_req_chrgr_chg_hist   hist,
					    mr_req_proc_step_det    det,
					    edm_emp                 emp
					WHERE
					    det.mr_req_proc_step_det_no = hist.mr_req_proc_step_det_no
					    AND det.del_yn = 0
					    AND hist.chrg_emp_no = emp.emp_id
					    AND hist.eff_end_dtm = '99991231235959'
					    AND hist.del_yn = 0
					    AND det.mr_req_proc_step_det_no = (
					        SELECT
					            MIN(det.mr_req_proc_step_det_no)
					        FROM
					            mr_req_proc_step_det    det,
					            mr_req_chrgr_chg_hist   hist
					        WHERE
					            det.mr_req_proc_step_det_no = hist.mr_req_proc_step_det_no
					            AND det.mr_step_cd = 'Z00R0'
					            AND det.mr_req_no = #{mrReqNo}
					            AND hist.chrgr_cl_cd = 'Z02D'
					            AND hist.eff_end_dtm = '99991231235959'
					            AND det.del_yn = 0
					            AND hist.del_yn = 0
					    )) as RGST_ID,
               replace(replace(GETDEPTNAMEANEMPNAME((SELECT
														    EMP2.EMP_ID
														    --, EMP.EMP_NAME
														FROM
														    mr_req_chrgr_chg_hist   hist2,
														    mr_req_proc_step_det    det2,
														    edm_emp                 emp2
														WHERE
														    det2.mr_req_proc_step_det_no = hist2.mr_req_proc_step_det_no
														    AND det2.del_yn = 0
														    AND hist2.chrg_emp_no = emp2.emp_id
														    AND hist2.eff_end_dtm = '99991231235959'
														    AND hist2.del_yn = 0
														    AND det2.mr_req_proc_step_det_no = (
														        SELECT
														            MIN(det3.mr_req_proc_step_det_no)
														        FROM
														            mr_req_proc_step_det    det3,
														            mr_req_chrgr_chg_hist   hist3
														        WHERE
														            det3.mr_req_proc_step_det_no = hist3.mr_req_proc_step_det_no
														            AND det3.mr_step_cd = 'Z00R0'
														            AND det3.mr_req_no = #{mrReqNo}
														            AND hist3.chrgr_cl_cd = 'Z02D'
														            AND hist3.eff_end_dtm = '99991231235959'
														            AND det3.del_yn = 0
														            AND hist3.del_yn = 0
														    ))),'HDO_', ''),'HDC_', '') AS RGST_NAME,
               
	                
				    RST.CONF_ID,
				    replace(replace(GETDEPTNAMEANEMPNAME(RST.CONF_ID),'HDO_', ''),'HDC_', '') AS CONF_NAME
               FROM MR_REQ_MST MR_REQ,
                    MR_RV_RST RST
              WHERE MR_REQ.MR_REQ_NO = RST.MR_REQ_NO(+)
                AND MR_REQ.MR_REQ_NO = #{mrReqNo}
              /*2025-09-17 ijs 자료검토 단계  위험성 검토 */
			    AND RST.MR_STEP_CD(+) LIKE #{mrStepCd} || '%'
			    AND MR_REQ.DEL_YN=0
                AND RST.DEL_YN(+)=0
    </select>
    

    <select id="selectMrHazopExe" parameterType="com.mr.common.domain.MrRvRstVO" resultMap="mrRvRstMap">
    --selectMrRvRst MR수행 위험성 검토 00 (타당성검토 확인 page. 기술 및 타당성 검토 (경제성, 법규상제약, 기술적제약, 개선효과 미흡)
             SELECT RST.MR_RV_RST_NO,
                    MR_REQ.MR_REQ_NO,
                    MR_REQ.MR_NO,
                    MR_REQ.PLANT,
                    <!-- <choose>
					  <when test="stepCd == 'Z0060' and stepCd != ''">
					    #{stepCd} AS MR_STEP_CD,
					  </when>
					  <otherwise>
					    'Z00R0' AS MR_STEP_CD,
					  </otherwise>
					</choose> -->
					
					'Z0060' AS MR_STEP_CD, 
                    
                    RST.MR_REQ_PROC_STEP_DET_NO,
                    RST.ITEM_CD,
                    RST.CL_CD_01,
                    RST.CL_CD_02,
                    RST.CL_CD_03,
                    RST.CL_CD_04,
                    RST.CL_CD_05,
                    RST.CL_CD_06,
                    RST.CL_CD_07,
                    RST.CL_CD_08,
                    RST.CL_CD_09,
                    RST.CL_CD_10,
                    RST.CL_CD_11,
                    RST.CL_CD_12,
                    RST.CL_CD_13,
                    RST.CL_CD_14,
                    RST.CL_CD_15,
                    RST.CL_CTT_01,
                    RST.CL_CTT_02,
                    RST.CL_CTT_03,
                    RST.CL_CTT_04,
                    RST.CL_CTT_05,
                    RST.CL_CTT_06,
                    RST.CL_CTT_07,
                    RST.CL_CTT_08,
                    RST.CL_CTT_09,
                    RST.CL_CTT_10,
                    RST.CL_CTT_11,
                    RST.CL_CTT_12,
                    RST.CL_CTT_13,
                    RST.CL_CTT_14,
                    RST.CL_CTT_15,
                    RST.CL_CMT_01,
                    RST.CL_CMT_02,
                    RST.CL_CMT_03,
                    RST.CL_CMT_04,
                    RST.CL_CMT_05,
                    RST.CL_CMT_06,
                    RST.CL_CMT_07,
                    RST.CL_CMT_08,
                    RST.CL_CMT_09,
                    RST.CL_CMT_10,
                    RST.CL_CMT_11,
                    RST.CL_CMT_12,
                    RST.CL_CMT_13,
                    RST.CL_CMT_14,
                    RST.CL_CMT_15,
                    MR_REQ.HAZOP_ACT_YN,
                    MR_REQ.PORC_ACT_YN,
                    <!-- TOT_RV_SUGG, yoo 241106 홑따음표 , 개행 문자 처리를 위해 아래 처럼 변경 --> 
                    REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(RST.TOT_RV_SUGG,CHR(10),'\n'),CHR(13),'\r'),'"','˝'), CHR(34), '¶'), CHR(39),'¶') AS TOT_RV_SUGG, 
                    RST.DEL_YN,
                    RST.FST_RGST_DT,
                    RST.FST_RGSTR,
                    RST.LAST_CHG_DT,
                    RST.LAST_CHGR,
                    <!-- 2025-07-09 IJS 컬럼추가 -->
                    replace(replace(GETDEPTNAMEANEMPNAME(RST.PE_ID),'HDO_', ''),'HDC_', '') as PE_NAME,
				    RST.PE_ID,
				    RST.PE_ADD_NAME,
				    (SELECT
					    EMP.EMP_ID
					    /*, EMP.EMP_NAME*/
					FROM
					    mr_req_chrgr_chg_hist   hist,
					    mr_req_proc_step_det    det,
					    edm_emp                 emp
					WHERE
					    det.mr_req_proc_step_det_no = hist.mr_req_proc_step_det_no
					    AND det.del_yn = 0
					    AND hist.chrg_emp_no = emp.emp_id
					    AND hist.eff_end_dtm = '99991231235959'
					    AND hist.del_yn = 0
					    AND det.mr_req_proc_step_det_no = (
					        SELECT
					            MIN(det.mr_req_proc_step_det_no)
					        FROM
					            mr_req_proc_step_det    det,
					            mr_req_chrgr_chg_hist   hist
					        WHERE
					            det.mr_req_proc_step_det_no = hist.mr_req_proc_step_det_no
					            AND det.mr_step_cd = 'Z00R0'
					            AND det.mr_req_no = #{mrReqNo}
					            AND hist.chrgr_cl_cd = 'Z02D'
					            AND hist.eff_end_dtm = '99991231235959'
					            AND det.del_yn = 0
					            AND hist.del_yn = 0
					    )) as RGST_ID,
               replace(replace(GETDEPTNAMEANEMPNAME((SELECT
														    EMP2.EMP_ID
														    --, EMP.EMP_NAME
														FROM
														    mr_req_chrgr_chg_hist   hist2,
														    mr_req_proc_step_det    det2,
														    edm_emp                 emp2
														WHERE
														    det2.mr_req_proc_step_det_no = hist2.mr_req_proc_step_det_no
														    AND det2.del_yn = 0
														    AND hist2.chrg_emp_no = emp2.emp_id
														    AND hist2.eff_end_dtm = '99991231235959'
														    AND hist2.del_yn = 0
														    AND det2.mr_req_proc_step_det_no = (
														        SELECT
														            MIN(det3.mr_req_proc_step_det_no)
														        FROM
														            mr_req_proc_step_det    det3,
														            mr_req_chrgr_chg_hist   hist3
														        WHERE
														            det3.mr_req_proc_step_det_no = hist3.mr_req_proc_step_det_no
														            AND det3.mr_step_cd = 'Z00R0'
														            AND det3.mr_req_no = #{mrReqNo}
														            AND hist3.chrgr_cl_cd = 'Z02D'
														            AND hist3.eff_end_dtm = '99991231235959'
														            AND det3.del_yn = 0
														            AND hist3.del_yn = 0
														    ))),'HDO_', ''),'HDC_', '') AS RGST_NAME,
               
	                
				    RST.CONF_ID,
				    replace(replace(GETDEPTNAMEANEMPNAME(RST.CONF_ID),'HDO_', ''),'HDC_', '') AS CONF_NAME
               FROM MR_REQ_MST MR_REQ,
                    MR_RV_RST RST
              WHERE MR_REQ.MR_REQ_NO = RST.MR_REQ_NO(+)
                AND MR_REQ.MR_REQ_NO = #{mrReqNo}
	            AND ITEM_CD = 'EXE_HAZOP'
              /*2025-09-17 ijs 자료검토 단계  위험성 검토 */
			    AND RST.MR_STEP_CD(+) LIKE 'Z0060' || '%'
			    AND MR_REQ.DEL_YN=0
                AND RST.DEL_YN(+)=0
    </select>
    
    <insert id="insertMrHazopExe" parameterType="com.mr.common.domain.MrRvRstVO">
    --실행 HAZOP 저장
        INSERT INTO MR_RV_RST (
            MR_RV_RST_NO,
            MR_REQ_NO,
            MR_REQ_PROC_STEP_DET_NO,
            ITEM_CD,
            CHRGR_CL_CD,
            CL_CD_01,
            CL_CD_02,
            CL_CD_03,
            CL_CD_04,
            CL_CD_05,
            CL_CD_06,
            CL_CD_07,
            CL_CD_08,
            CL_CD_09,
            CL_CD_10,
            CL_CD_11,
            CL_CD_12,
            CL_CD_13,
            CL_CD_14,
            CL_CD_15,
            CL_CTT_01,
            CL_CTT_02,
            CL_CTT_03,
            CL_CTT_04,
            CL_CTT_05,
            CL_CTT_06,
            CL_CTT_07,
            CL_CTT_08,
            CL_CTT_09,
            CL_CTT_10,
            CL_CTT_11,
            CL_CTT_12,
            CL_CTT_13,
            CL_CTT_14,
            CL_CTT_15,
            CL_CMT_01,
            CL_CMT_02,
            CL_CMT_03,
            CL_CMT_04,
            CL_CMT_05,
            CL_CMT_06,
            CL_CMT_07,
            CL_CMT_08,
            CL_CMT_09,
            CL_CMT_10,
            CL_CMT_11,
            CL_CMT_12,
            CL_CMT_13,
            CL_CMT_14,
            CL_CMT_15,
            TOT_RV_SUGG,
            DEL_YN,
            FST_RGST_DT,
            FST_RGSTR,
            LAST_CHG_DT,
            LAST_CHGR
        ) VALUES (
            (SELECT NVL(MAX(MR_RV_RST_NO), 0) + 1 FROM MR_RV_RST),
            #{mrReqNo},
            #{mrReqProcStepDetNo},
            'EXE_HAZOP',
            #{chrgrClCd},
            #{clCd01},
            #{clCd02},
            #{clCd03},
            #{clCd04},
            #{clCd05},
            #{clCd06},
            #{clCd07},
            #{clCd08},
            #{clCd09},
            #{clCd10},
            #{clCd11},
            #{clCd12},
            #{clCd13},
            #{clCd14},
            #{clCd15},
            #{clCtt01},
            #{clCtt02},
            #{clCtt03},
            #{clCtt04},
            #{clCtt05},
            #{clCtt06},
            #{clCtt07},
            #{clCtt08},
            #{clCtt09},
            #{clCtt10},
            #{clCtt11},
            #{clCtt12},
            #{clCtt13},
            #{clCtt14},
            #{clCtt15},
            #{clCmt01},
            #{clCmt02},
            #{clCmt03},
            #{clCmt04},
            #{clCmt05},
            #{clCmt06},
            #{clCmt07},
            #{clCmt08},
            #{clCmt09},
            #{clCmt10},
            #{clCmt11},
            #{clCmt12},
            #{clCmt13},
            #{clCmt14},
            #{clCmt15},
            #{totRvSugg},
            0,
            SYSDATE,
            #{loginEmpNo},
            SYSDATE,
            #{loginEmpNo}
        )
    </insert>

    <update id="updateMrHazopExe" parameterType="com.mr.common.domain.MrRvRstVO">
    --실행 HAZOP 수정
        UPDATE MR_RV_RST
           SET CL_CD_01 = #{clCd01},
               CL_CD_02 = #{clCd02},
               CL_CD_03 = #{clCd03},
               CL_CD_04 = #{clCd04},
               CL_CD_05 = #{clCd05},
               CL_CD_06 = #{clCd06},
               CL_CD_07 = #{clCd07},
               CL_CD_08 = #{clCd08},
               CL_CD_09 = #{clCd09},
               CL_CD_10 = #{clCd10},
               CL_CD_11 = #{clCd11},
               CL_CD_12 = #{clCd12},
               CL_CD_13 = #{clCd13},
               CL_CD_14 = #{clCd14},
               CL_CD_15 = #{clCd15},
               CL_CTT_01 = #{clCtt01},
               CL_CTT_02 = #{clCtt02},
               CL_CTT_03 = #{clCtt03},
               CL_CTT_04 = #{clCtt04},
               CL_CTT_05 = #{clCtt05},
               CL_CTT_06 = #{clCtt06},
               CL_CTT_07 = #{clCtt07},
               CL_CTT_08 = #{clCtt08},
               CL_CTT_09 = #{clCtt09},
               CL_CTT_10 = #{clCtt10},
               CL_CTT_11 = #{clCtt11},
               CL_CTT_12 = #{clCtt12},
               CL_CTT_13 = #{clCtt13},
               CL_CTT_14 = #{clCtt14},
               CL_CTT_15 = #{clCtt15},
               CL_CMT_01 = #{clCmt01},
               CL_CMT_02 = #{clCmt02},
               CL_CMT_03 = #{clCmt03},
               CL_CMT_04 = #{clCmt04},
               CL_CMT_05 = #{clCmt05},
               CL_CMT_06 = #{clCmt06},
               CL_CMT_07 = #{clCmt07},
               CL_CMT_08 = #{clCmt08},
               CL_CMT_09 = #{clCmt09},
               CL_CMT_10 = #{clCmt10},
               CL_CMT_11 = #{clCmt11},
               CL_CMT_12 = #{clCmt12},
               CL_CMT_13 = #{clCmt13},
               CL_CMT_14 = #{clCmt14},
               CL_CMT_15 = #{clCmt15},
               TOT_RV_SUGG = #{totRvSugg},
               LAST_CHG_DT = SYSDATE,
               LAST_CHGR = #{loginEmpNo}
         WHERE MR_REQ_NO = #{mrReqNo}
           AND ITEM_CD = 'EXE_HAZOP'
           AND DEL_YN = 0
    </update>

    <!-- ========================================
         실행 CHECK 관련 쿼리 (3개)
         ======================================== -->
    <resultMap id="mrCheckMasterExeMap" type="com.mr.jobs.domain.JobsCheckMasterVO">
        <id property="mrHazopNo" column="MR_HAZOP_NO" />
        <result property="mrReqNo" column="MR_REQ_NO" />
        <result property="mrNo" column="MR_NO" />
        <result property="mrReqTitle" column="MR_REQ_TITLE" />
        <result property="rvTeamDt" column="RV_TEAM_DT" />
        <result property="rvTeamId" column="RV_TEAM_ID" />
        <result property="rvTeamName" column="RV_TEAM_NAME" />
        <result property="rvTeamSugg" column="RV_TEAM_SUGG" />
        <result property="rvChkMtr" column="RV_CHK_MTR" />
        <result property="rgstId" column="RGST_ID" />
        <result property="rgstName" column="RGST_NAME" />
        <result property="confId" column="CONF_ID" />
        <result property="confName" column="CONF_NAME" />
        <result property="delYn" column="DEL_YN" />
        <result property="fstRgstDt" column="FST_RGST_DT" />
        <result property="fstRgstr" column="FST_RGSTR" />
        <result property="lastChgDt" column="LAST_CHG_DT" />
        <result property="lastChgr" column="LAST_CHGR" />
        <result property="peName" column="PE_NAME" />
        <result property="peId" column="PE_ID" />
        <result property="peAddName" column="PE_ADD_NAME" />
        <result property="rvEmpName" column="RV_EMP_NAME" />
        <result property="rvEmpId" column="RV_EMP_ID" />
        <result property="rvDeptName" column="RV_DEPT_NAME" />      
        <collection property="checks" ofType="com.mr.jobs.domain.JobsCheckVO" column="MR_HAZOP_NO" select="selectMrCHeck" />
    </resultMap>
    
    <select id="selectMrCheckExe" resultMap="mrCheckMasterExeMap" resultType="com.mr.jobs.domain.JobsCheckMasterVO">
    	-- MR수행 위험성검토 체크리스트 항목 별 values//
        SELECT HAZOP.MR_HAZOP_NO,
               MR.MR_REQ_NO,
               MR.MR_NO,
               MR.MR_REQ_TITLE,
               HAZOP.RV_TEAM_DT,
               RV.ORG_NAME AS RV_TEAM_NAME,
               HAZOP.RV_TEAM_ID,
               HAZOP.RV_TEAM_SUGG,
               HAZOP.RV_CHK_MTR,
               
               (SELECT
				    EMP.EMP_ID
				FROM
				    mr_req_chrgr_chg_hist   hist,
				    mr_req_proc_step_det    det,
				    edm_emp                 emp
				WHERE
				    det.mr_req_proc_step_det_no = hist.mr_req_proc_step_det_no
				    AND det.del_yn = 0
				    AND hist.chrg_emp_no = emp.emp_id
				    AND hist.eff_end_dtm = '99991231235959'
				    AND hist.del_yn = 0
				    AND det.mr_req_proc_step_det_no = (
				        SELECT
				            MIN(det.mr_req_proc_step_det_no)
				        FROM
				            mr_req_proc_step_det    det,
				            mr_req_chrgr_chg_hist   hist
				        WHERE
				            det.mr_req_proc_step_det_no = hist.mr_req_proc_step_det_no
				            AND det.mr_step_cd = 'Z00R0'
				            AND det.mr_req_no = #{mrReqNo}
				            AND hist.chrgr_cl_cd = 'Z02D'
				            AND hist.eff_end_dtm = '99991231235959'
				            AND det.del_yn = 0
				            AND hist.del_yn = 0
				    )) as RGST_ID, 								 /* 담당엔지니어링, 기술검토 담당자*/
               replace(replace(GETDEPTNAMEANEMPNAME((SELECT
														    EMP2.EMP_ID
														FROM
														    mr_req_chrgr_chg_hist   hist2,
														    mr_req_proc_step_det    det2,
														    edm_emp                 emp2
														WHERE
														    det2.mr_req_proc_step_det_no = hist2.mr_req_proc_step_det_no
														    AND det2.del_yn = 0
														    AND hist2.chrg_emp_no = emp2.emp_id
														    AND hist2.eff_end_dtm = '99991231235959'
														    AND hist2.del_yn = 0
														    AND det2.mr_req_proc_step_det_no = (
														        SELECT
														            MIN(det3.mr_req_proc_step_det_no)
														        FROM
														            mr_req_proc_step_det    det3,
														            mr_req_chrgr_chg_hist   hist3
														        WHERE
														            det3.mr_req_proc_step_det_no = hist3.mr_req_proc_step_det_no
														            AND det3.mr_step_cd = 'Z00R0'
														            AND det3.mr_req_no = #{mrReqNo}
														            AND hist3.chrgr_cl_cd = 'Z02D'
														            AND hist3.eff_end_dtm = '99991231235959'
														            AND det3.del_yn = 0
														            AND hist3.del_yn = 0
														    ))),'HDO_', ''),'HDC_', '') AS RGST_NAME,     /*담당엔지니어링, 기술검토 담당자*/
               HAZOP.CONF_ID,  
               replace(replace(GETDEPTNAMEANEMPNAME(HAZOP.CONF_ID),'HDO_', ''),'HDC_', '') AS CONF_NAME,
               HAZOP.DEL_YN,
               HAZOP.FST_RGST_DT,
               HAZOP.FST_RGSTR,
               HAZOP.LAST_CHG_DT,
               HAZOP.LAST_CHGR,
             
			    replace(replace(GETDEPTNAMEANEMPNAME(HAZOP.PE_ID),'HDO_', ''),'HDC_', '') as PE_NAME,
			    HAZOP.PE_ADD_NAME,
			    HAZOP.PE_ID,
			    replace(replace(GETDEPTNAMEANEMPNAME(HAZOP.RV_EMP_ID),'HDO_', ''),'HDC_', '') as RV_EMP_NAME,
			    HAZOP.RV_EMP_ID,
			    HAZOP.RV_DEPT_NAME  
          FROM (SELECT *
                  FROM MR_HAZOP
                 WHERE DEL_YN=0) HAZOP,
               MR_REQ_MST MR,
               EDM_ORG RV,
               EDM_EMP RGST,
               EDM_EMP CONF
         WHERE MR.MR_REQ_NO = HAZOP.MR_REQ_NO(+)
           AND HAZOP.RV_TEAM_ID = RV.ORG_ID(+)
           AND HAZOP.RGST_ID = RGST.EMP_ID(+)
           AND HAZOP.CONF_ID = CONF.EMP_ID(+)
           AND MR.MR_REQ_NO = #{mrReqNo}
           AND MR.DEL_YN=0
           AND hazop.mr_step_cd(+) LIKE 'Z0060' || '%'
           
    </select>

    <insert id="insertMrCheckExe" parameterType="com.mr.jobs.domain.JobsCheckMasterVO">
    --실행 CHECK Master 저장
        <selectKey keyProperty="mrHazopNo" resultType="int" order="BEFORE">
            SELECT NVL(MAX(MR_HAZOP_NO),0)+1
              FROM MR_HAZOP
        </selectKey>
       -- 체크리스트 팀 구성 insert1
       INSERT INTO MR_HAZOP(
                   MR_HAZOP_NO,
                   MR_REQ_NO,
                   RV_TEAM_DT,
                   RV_TEAM_ID,
                   RV_TEAM_SUGG,
                   RV_CHK_MTR,
                   RGST_ID,   /*담당엔지니어링, 기술검토 담당자*/
                   CONF_ID,
                   DEL_YN,
                   FST_RGST_DT,
                   FST_RGSTR,
                   LAST_CHG_DT,
                   LAST_CHGR,
             
			       PE_ADD_NAME,
			       PE_ID,
				   RV_EMP_ID,
			       RV_DEPT_NAME,
			       MR_STEP_CD 
             ) VALUES ( #{mrHazopNo},
                        #{mrReqNo},
                        #{rvTeamDt},
                        #{rvTeamId},
                        #{rvTeamSugg},
                        #{rvChkMtr},
                        #{rgstId},
                        #{confId},
                        0,
                        SYSDATE,
                        #{loginEmpNo},
                        SYSDATE,
                        #{loginEmpNo}, 
                        
					    #{peName},
					    #{peId},
					    #{rvEmpId},
					    #{rvDeptName},
					    'Z0060' 
                        )
    </insert>

    <update id="updateMrCheckExe" parameterType="com.mr.jobs.domain.JobsCheckMasterVO">
    --실행 CHECK Master 수정
        UPDATE MR_CHECK_MASTER
           SET CHK_TTL = #{chkTtl},
               CHK_CNTN = #{chkCntn},
               LAST_CHG_DT = SYSDATE,
               LAST_CHGR = #{loginEmpNo}
         WHERE MR_REQ_NO = #{mrReqNo}
           AND MR_STEP_CD = #{mrStepCd}
           AND DEL_YN = 0
    </update>
       

</mapper>