<%@ page language="java" contentType="text/html; charset=utf-8" pageEncoding="utf-8" %>
<%@ include file="/WEB-INF/includes/taglibs.jsp" %>
<%@ page import="com.base.util.IsOperDistinc" %>
<%@ taglib uri="http://tiles.apache.org/tags-tiles" prefix="tiles"%>
<s:eval var="authenticationKey" expression="T(com.mr.common.domain.Authentication).SESSION_ATTRIBUTE_KEY"/>

<!doctype html>
<html lang="ko">
  <head>
    <base href="${pageContext.request.contextPath}/">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../../docs-assets/ico/favicon.png">
    <title>MR</title>

    <!-- Bootstrap core CSS -->
    <link href="css/common.css" rel="stylesheet">
    <% if(IsOperDistinc.m_bOperDatabaseConfig){ %>
      <link href="css/layout.css" rel="stylesheet">
      <% }else { %>
      <link href="css/layout_dev.css" rel="stylesheet">
      <% } %>
    
    <link href="css/popup.css" rel="stylesheet">

    <!-- jquery-ui css -->
    <link href="css/widgets/jquery-ui.css" rel="stylesheet">

    <!-- jquery script -->
    <script src="js/jquery/jquery-1.10.2.min.js"></script>
    <script src="js/sortable/jquery.tablesorter.js"></script>

    <!-- jquery-ui script & datepicker i18n -->
    <script src="js/widgets/jquery-ui.min.js"></script>
    <script src="js/widgets/i18n/jquery.ui.datepicker-ko.js"></script>

    <script src="js/widgets/addon/timepicker/jquery-ui-timepicker-addon.js"></script>
    <script src="js/widgets/addon/timepicker/i18n/jquery-ui-timepicker-ko.js"></script>

    <!-- common scripts -->
    <script src="js/common/common.js"></script>
    <script src="js/common/common.ajax.js"></script>
    <script src="js/common/common.validation.js"></script>
    <script src="js/file/file_with_jQuery.js"></script>

    <script type="text/javascript">
        var url = document.location.href;
        var startIndex = url.indexOf("/mr/")+4;
        var endIndex = url.indexOf(".do");
        var requestURI = url.substring(startIndex, endIndex);
        var edimsAddr = url.substring(7, url.indexOf("/mr/"));
        var isInstalled = false;
        var agt = navigator.userAgent.toLowerCase();

        $(document).ready(function(){

        	if(agt.indexOf("msie") != -1) {

            try {
                if(navigator.userAgent.match(/Trident\/(\d.\d)/i)[1] == '6.0'){
                } else {
                    alert("익스플로러 10이하는 지원하지 않습니다.");
                    return;
                }

                var axObj = new ActiveXObject("XRapidView.XRapidViewCtrl.7");
                if(axObj){
                    isInstalled = true;
                } else {
                    isInstalled = false;
                }
            } catch(e) {
                console.log(e);
                alert("XRapidView Error 관리자에게 문의하세요.");
                isInstalled = false;
            }

            if(!isInstalled){
              document.location.href = "http://"+edimsAddr+"/edims/std/com/download.jsp?reqUri=" + edimsAddr +"/mr/";
            }
            }

            var failMessage = "${failMessage}";
            if (failMessage != "") {
                alert(failMessage);
            }



            $('#pageLoadingWrap').css('width' ,  $(window).width());
            $('#pageLoadingWrap').css('height' ,  $(window).height());
            $(window).resize(function() {
              $('#pageLoadingWrap').css('width' ,  $(window).width());
              $('#pageLoadingWrap').css('height' ,  $(window).height());
            });

            $.removeComma = function(){
                $('.number').each(function(){
                      $(this).val($(this).val().replace(/[,]/g, ""));
                });
            };



                var maxDate=0;
                var nowDate = new Date();
                switch (nowDate.getDay()) {
                case 0:
                    maxDate = 5;
                    break;
                case 6:
                    maxDate = 6;
                    break;
                default:
                    maxDate = 7;
                    break;
                }
                nowDate.setDate(nowDate.getDate()+maxDate);

        	$(".inputDate").datepicker({
        	    dateformat:"yyyy-mm-dd",
        	    showOn:"button",
        	    changeYear: true,
        	    changeMonth: true,
        	    buttonImage:"images/icon_calendar.png",
        	    buttonImageOnly:true,
        	    minDate: "today"
            });
        	$(".limitDate").datepicker("setDate",nowDate);



            $(".inputBeforeDate").datepicker({
                dateformat:"yyyy-mm-dd",
                showOn:"button",
                changeYear: true,
                changeMonth: true,
                buttonImage:"images/icon_calendar.png",
                buttonImageOnly:true,
                maxDate: "today"
            });


        	$("img.ui-datepicker-trigger").attr("style", "border=0;cursor:Pointer;vertical-align:middle;margin-left: 4px;margin-right: 4px;");
        	$(".ui-datepicker-month").attr("width", "30px");

        	$(document).on("focusout",".number",function(event) {
                $(this).val($.separator($(this).val()));
            });

            $(document).on("focusin",".number",function(event) {
                  var value = $(this).val().replace(/[^0-9]/g, '');
                  value = value*1;
                  $(this).val(value);
            });

        	$(".leftMenu").mouseover(function() {
                $(this).css("background","#fcf8e3");
             }).mouseleave(function() {
                $(this).css("background","#ffffff");
             }).click(function(){
        		location.replace($(this).attr("data-role")+".do");
        	});

            $(".leftSubStep").mouseover(function() {
            	$(this).css("font-weight","bold");
             }).mouseleave(function() {
            	if($(this).attr("class").indexOf("ing")>0 && $(this).attr("class").indexOf("finish")<0) {
            		$(this).css("background","#ffea00");
            	} else if($(this).attr("class").indexOf("finish")>0) {
            		$(this).css("background","#9acefd");
            	} else {
            		$(this).css("background","#ffffff");
            	}
            	$(this).css("font-weight","normal");

             }).click(function(){
            	if($(this).children(".span_progress").html() =="") {
            		alert("완료, 진행중인 단계가 아닙니다.");
            	} else if ($("#mrReqNo").val()!="" && $("#mrReqNo").val()!="0" ){
            	    location.replace($(this).attr("data-role")+".do?mrReqNo="+$("#mrReqNo").val());
            	}
            });

            //첨부파일관리 추가
            $(document).on("click", "#addFile",function(){
           		if((agt.indexOf("msie") == -1) && (navigator.userAgent.search("Trident") == -1)){
         			alert("현재 이용중인 브라우저는 파일업로드를 지원하지 않습니다. 인터넷 익스플로러를 이용하세요.");
         		    return;
            	} 
            	
                var fileTemp = $("#fileTemp").children("tbody").children("tr");
                var fileTempTd = fileTemp.children("td");
                fileCnt = $("#fileList").children("tbody").children("tr:last").index();
                fileTempTd.children(".multipartFile").attr("name","mrAtchFiles["+fileCnt+"].fileNm");
                fileTempTd.children(".fileCd").attr("name","mrAtchFiles["+fileCnt+"].fileCd");
                fileTempTd.children(".insFlag").attr("name","mrAtchFiles["+fileCnt+"].inserted");
                fileTempTd.children(".drawMngNo").attr("name","mrAtchFiles["+fileCnt+"].drawMngNo");
                fileTemp.clone().insertAfter($("#fileList").children("tbody").children("tr:last"));
            });

            // 첨부파일관리 다운로드
            $(document).on("click", ".fileDown", function() {
            	if($(this).parent("td").children(".drawMngNo").val()==""){
            		alert("도면관리번호가 누락되었습니다. 관리자에게 문의하세요.");
            		return;
            	}
            	document.location.href = "download.do?drawMngNo="+$(this).parent("td").children(".drawMngNo").val();
            });
            // 추가한 파일 삭제
            $(document).on("click", ".removeFile", function() {
                $(this).parent("td").parent("tr").remove();
            });

            // 저장된 파일 삭제
            $(document).on("click", ".removeDownFile", function() {
                $(this).parent("td").children(".delFlag").val("true");
                $(this).parent("td").parent("tr").attr("style", "display:none");
            });

            // 파일구분 Select
            $.selectLoad({
                className : "fileDiv",
                url : "codeList.do?mrCommGrpCd=ATCH",
                defaultText : "선택",
            });

            $(window).ajaxStart(function() {
            	$('#pageLoadingWrap').show();
            }).ajaxStop(function() {
            	$('#pageLoadingWrap').hide();
            }).ajaxComplete(function() {
                $('#pageLoadingWrap').hide();
            }).ajaxError(function() {
                $('#pageLoadingWrap').hide();
            }).ajaxSuccess(function() {
                $('#pageLoadingWrap').hide();
            });
        });

        $(document).on("change",".fileForm", function () {
        	var fileList = new Array();
        	var fileName = this.value;
        	if(fileName.indexOf("fake")>0) {
                if(confirm("익스플로러 - 옵션 - 보안 - 신뢰할수 있는 사이트에 \n 추가가 필요합니다. \n 추가하는 방법 가이드로 이동하겠습니까?")) {
                	$.popup({url:"fileUploadErrorGuide.jsp", width:"1000", height:"500", scroll:"yes"});
                }
                return false;
        	}

        	var td = $(this).parent("td");
        	var fileTemp = $("#fileTemp").children("tbody").children("tr");
        	var fileTr;
        	var fileType;
        	var fileTempTd = fileTemp.children("td");
        	var drive = fileName.substring(0,4);
        	fileList = fileName.split(", "+drive);

        	if(fileList.length>1){
        		fileType = td.children(".fileCd").val();
        		td.parent("tr").remove();
                for( var i = 0; i<fileList.length; i++){
                    fileCnt = $("#fileList").children("tbody").children("tr:last").index();


                    fileTempTd.children(".multipartFile").attr("name","mrAtchFiles["+fileCnt+"].fileNm");
                    fileTempTd.children(".fileCd").attr("name","mrAtchFiles["+fileCnt+"].fileCd");
                    fileTempTd.children(".insFlag").attr("name","mrAtchFiles["+fileCnt+"].inserted");
                    fileTempTd.children(".drawMngNo").attr("name","mrAtchFiles["+fileCnt+"].drawMngNo");
                    fileTemp.clone().insertAfter($("#fileList").children("tbody").children("tr:last"));

                    fileTr = $("#fileList").children("tbody").children("tr:last");
                    fileTr.children("td").children(".realPath").val(i==0 ? fileList[i] : drive+fileList[i]);
                    fileTr.children("td").children(".fileCd").val(fileType);
                    fileTr.children("td").children(".multipartFile").val(fileList[i].substring(fileList[i].lastIndexOf("\\") + 1, fileList[i].length));

                }
        	} else {
        		td.find(".realPath").val(fileName);
        		td.find(".multipartFile").val(fileName.substring(fileName.lastIndexOf("\\") + 1, fileName.length));
        	}
        });

        $(document).on("click",".inputFile", function () {
            $(this).parent("td").find(".fileForm").click();
        });


        $(document).on("click",".help", function () {
        	$.popup({url:"popup/help.do", width:"1260", height:"718", scroll:"yes"});
        });



        $(document).submit(function() {

        	var td;
        	var realPath = "";

        	if(!$.fileCdValidation()) {
        		alert("파일구분을 선택하세요.");
        		$('#pageLoadingWrap').hide();
        		return false;
        	}

            if(!$.fileNameValidation()) {
                alert("파일을 선택하세요.");
                $('#pageLoadingWrap').hide();
                return false;
            }

            if(!$.filePathValidation()) {
                if(confirm("익스플로러 - 옵션 - 보안 - 신뢰할수 있는 사이트에 \n 추가가 필요합니다. \n 추가하는 방법 가이드로 이동하겠습니까?")) {
                    $.popup({url:"fileUploadErrorGuide.jsp", width:"1000", height:"500", scroll:"yes"});
                }
                $('#pageLoadingWrap').hide();
                return false;
            }

        	$(document).find(".multipartFile").each(function(){
        		td = $(this).parent("td");
        		if($(this).val()!=""){
        			  if(td.children(".insFlag").val()=="true") {
        				  realPath = td.children(".realPath").val().replace(/\\/g, '/');
        				  td.children(".drawMngNo").val($.fileUpload({ localAddr: edimsAddr, filePath : realPath , empNo: "${sessionScope[authenticationKey].empNo}", plantNo:$("#plantNo").val(), mrNo:$("#mrNo").val()}));
        			  }
        		}
        	});

        });

        $.fileCdValidation = function () {
        	var count = 0;
        	$("form").find(".fileCd").each(function(){
        		if($(this).parent("td").children(".insFlag").val()=="true") {
                    $(this).css("border-style","solid");
                    $(this).css("border-color","#e5e5e5");
                    $(this).css("border-width","1px");
            		if($(this).val() == "" ){
            			  $(this).focus();
            	          $(this).css("border-style","solid");
            	          $(this).css("border-color","#91ce44");
            	          $(this).css("border-width","2px");
            	          count++;
            		}
        		}
        	});

        	if(count>0){
        		return false;
        	} else {
        		return true;
        	}
        };


        $.filePathValidation = function () {
            var count = 0;
            $("form").find(".realPath").each(function(){
                if($(this).val().indexOf("fake")>-1) {
                	count++;
                }
            });

            if(count>0){
                return false;
            } else {
                return true;
            }
        };

        $.fileNameValidation = function () {
            var count = 0;
            $("form").find(".multipartFile").each(function(){
                if($(this).parent("td").children(".insFlag").val()=="true") {
                    $(this).css("border-style","solid");
                    $(this).css("border-color","#e5e5e5");
                    $(this).css("border-width","1px");
                    if($(this).val() == "" ){
                          $(this).focus();
                          $(this).css("border-style","solid");
                          $(this).css("border-color","#91ce44");
                          $(this).css("border-width","2px");
                          count++;
                    }
                }
            });

            if(count>0){
                return false;
            } else {
                return true;
            }
        };
    </script>

  </head>
  <body>
  <div id="pageLoadingWrap" style="position:absolute; top:0px;left:0px; display:none; background-color:white; z-index:1000; filter: alpha(opacity=50); -khtml-opacity: 0.5; -moz-opacity:0.5; opacity: 0.5;">
    <div id="pageLoading" style="position:absolute;top:50%;left:50%;z-index:999">
         <img src="images/ajax_progress.gif" />
    </div>
  </div>

  <div id="header">
      <div class="navbar_brand"><a href="main.do">
      <% if(IsOperDistinc.m_bOperDatabaseConfig){ %>
      <img id="logo" src="images/img_logo.png">
      <% }else { %>
      <img id="logo" src="images/img_logo_dev.png">
      <% } %>
      </a></div>
      <div class="navbar_nav">
            <ul>
              <li class="help cursor"><a class="cursor">HELP</a></li>
              <li class="divider"></li>
            <c:if test="${sessionScope[authenticationKey].empNo eq 'admin'}">
              <li><a href="mngrCode.do">기준정보</a></li>
              <li class="divider"></li>
              <li><a href="mngrChange.do">MR정보</a></li>
              <!-- <li><a href="mngrChangeNew.do">MR정보New</a></li>  -->
              <li class="divider"></li>
            </c:if>
            <li>현재 로그인 사용자 : <c:out value="${sessionScope[authenticationKey].empName}"/></li>
            <li><a href="logout.do"><span class="button_logout"><img src="images/btn_t_logout.png" /></span></a></li>
            </ul>
      </div>
  </div>
  <div id="container">
      <div id="left"><%@include file="leftMenu.jsp" %></div>
      <div id="warp">
      <div id="content">
          <%-- Contents 내용을 들어올 자리 --%>
          <tiles:insertAttribute name="content" />
          <br>
          <br>
          <br>
     </div>
     </div>
  </div>

<div class="form_group">
  <table id="fileTemp" class="table_row" border="1" cellspacing="0" style="display:none">
      <tr>
      <td>
        <select class="fileDiv fileCd" name="mrAtchFiles[0].fileCd"></select>
        <input type="file" class="fileForm" multiple>
        <input type="hidden" class="realPath i_input_300">
        <input type="text" class="i_input_300 multipartFile fileNm" name="mrAtchFiles[0].fileNm">
        <img src="images/btn_search.png" class="inputFile cursor"/>
        <img id="deleteFile" class="cursor removeFile" src="images/icon_minus.png" />
        <input type="hidden" class="i_input_200 insFlag" name="mrAtchFiles[0].inserted" value="true"/>
        <input type="hidden" class="drawMngNo" name="mrAtchFiles[0].drawMngNo" value=""/>
      </td>
      </tr>
  </table>

</div>

<!--     <div id="footer">
      <p class="text-muted"><b>Modification Request Management</b></p>
    </div> -->
  <script type="text/javascript">
    $(document).ready(function(){
    	if("${modeClass}"!="") {
        $('.${modeClass}').attr('disabled',false);
        $('.${modeClass}').attr('readonly',false);
        $('.${modeClass}').show();
     }

     "<c:forEach var='mrStep' items='${mrSteps}'>";

        $(".${mrStep.mrStepCd}").children(".span_progress").html("${mrStep.procStNm}");

        if(/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/.test("${mrStep.procStNm}")){
            $(".${mrStep.mrStepCd}").addClass("smenu_ing");
            if("${mrStep.mrStepCd}"=="Z0020" || "${mrStep.mrStepCd}"=="Z0030" || "${mrStep.mrStepCd}"=="Z0040")
            {
            	$(".Z0020-A").children(".span_progress").html("진행중");
            	$(".Z0020-A").addClass("smenu_ing");
            } else if ("${mrStep.mrStepCd}"!="Z0010") {
                $(".Z0020-A").children(".span_progress").html("완료");
                $(".Z0020-A").addClass("smenu_finish");
            }
        } else if ("${mrStep.procStNm}"!="") {
            $(".${mrStep.mrStepCd}").addClass("smenu_finish");
        }

        if("${mrStep.procStCd}"=="Z0143"){
        	 $(".${mrStep.mrStepCd}").children(".span_progress").html("사업취소");
        	 $(".${mrStep.mrStepCd}").addClass("smenu_finish");
             if ("${mrStep.mrStepCd}"!="Z0010") {
                 $(".Z0020-A").children(".span_progress").html("");
             }

        }
        
        if("${mrStep.mrStepCd}"=="Z0030" && "${mrStep.procStCd}"=="Z0133") {
        	$(".${mrStep.mrStepCd}").children(".span_progress").html("<fmt:formatDate value='${mrStep.lastChgDt}' pattern='yyyy-MM-dd' />");
        	$(".${mrStep.mrStepCd}").addClass("smenu_finish");

        	$(".${mrStep.mrStepCd}-A").children(".span_progress").html("확인요청");
        	$(".${mrStep.mrStepCd}-A").addClass("smenu_ing");
        } else if ("${mrStep.mrStepCd}"=="Z0030" && ("${mrStep.procStCd}"=="Z0122" || "${mrStep.procStCd}"=="Z0131")) {
            $(".${mrStep.mrStepCd}").children(".span_progress").html("<fmt:formatDate value='${mrStep.lastChgDt}' pattern='yyyy-MM-dd' />");
            $(".${mrStep.mrStepCd}").addClass("smenu_finish");
            $(".${mrStep.mrStepCd}-A").children(".span_progress").html("${mrStep.procStNm}");
            $(".${mrStep.mrStepCd}-A").addClass("smenu_ing");
        }

        if("${mrStep.mrStepCd}"=="Z0030" && "${mrStep.procStCd}"=="Z0132") {
        	$(".${mrStep.mrStepCd}-A").children(".span_progress").html("<fmt:formatDate value='${mrStep.lastChgDt}' pattern='yyyy-MM-dd' />");
        	$(".${mrStep.mrStepCd}-A").addClass("smenu_finish");
        }

        if("${mrStep.mrStepCd}"=="Z0030" && "${mrStep.procStCd}"=="Z0132") {
            $(".${mrStep.mrStepCd}-A").children(".span_progress").html("<fmt:formatDate value='${mrStep.lastChgDt}' pattern='yyyy-MM-dd' />");
            $(".${mrStep.mrStepCd}-A").addClass("smenu_finish");
        }

        "</c:forEach>";

        $(".leftSubStep").each(function(){
            if(requestURI==$(this).attr("data-role")){
            	   $(this).children(".leftmenu_over").css("visibility","visible");



            }
        });

    });
  </script>
  </body>
</html>