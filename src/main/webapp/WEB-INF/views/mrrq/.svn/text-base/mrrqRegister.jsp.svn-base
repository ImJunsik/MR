<%@ page language="java" contentType="text/html; charset=utf-8" pageEncoding="utf-8" %>
<%@ include file="/WEB-INF/includes/taglibs.jsp" %>
<!-- title -->
<div id="content_header">
    <h4 class="content_header title"> MR요청서</h4>
</div>

    <script>
    //alert("${modeClass}");
    //alert("${appLine.chrgrClCd}");
    //alert("${appLine.ifStatCd}");
    //alert("${appLine.chrgEmpNo}");
    //alert("${appLine.loginEmpNo}");
    </script>    

<!-- button -->
<div class="button_top">
    <!-- hajewook 재전송 추가  -->
    <c:forEach var='appLine' items='${register.appLine}' varStatus="loop">
	    <c:if test="${appLine.chrgrClCd == 'Z02A'}">
		    <c:if test="${appLine.ifStatCd != '1' && appLine.chrgEmpNo == register.loginEmpNo}">
		    	<input type="image" src="images/btn_reRequestApproval.png" style="display:none" class="cursor reAppReq ABB"/><!-- 재상신 -->
		    </c:if>
	    </c:if>
    </c:forEach>
    <input type="image" src="images/btn_temp.png" style="display:none" class="cursor save AAA"/><!-- 임시저장 -->
    <input type="image" src="images/btn_requestApproval.png" style="display:none" class="cursor appReq AAA"/>
    <!-- hajewook 수정 mr에서 승인/반려 불가 로직 수정(시작)  -->
    <input type="image" src="images/btn_approve.png" style="display:none" class="cursor app ABA ADA ACA"/><!-- 승인 -->
    <!-- <input type="image" src="images/btn_return.png" style="display:none" class="cursor return ABA ADA ACA"/>-->
    <input type="image" src="images/btn_approve.png" style="display:none" class="cursor app"/>
    <input type="image" src="images/btn_return.png" style="display:none" class="cursor return"/>
    <!-- hajewook 수정 mr에서 승인/반려 불가 로직 수정(종료)  -->    
    <input type="image" src="images/btn_cancelMR.png" style="display:none" class="cursor cancel ADA ACA"/>    
</div>
<br>
<input type="image" src="images/btn_cancelMR.png" class="cursor cancel ADA ACA"/>

<div id="content_wrap">

<c:set var="appLineCount" value="0"/>
<form id="registerForm" method="post">
    <input type="hidden" id="mrReqNo" name="mrReqNo" value="<c:out value="${register.mrReqNo}"/>"/>
    <input type="hidden" id="mrNo" value="<c:out value="${register.mrNo}"/>"/>
    <input type="hidden" id="plantNo" value="<c:out value="${register.plant}"/>"/>
    

    <table class="table_row" border="1" cellspacing="0">
        <caption class="blind"></caption>
        <colgroup>
        <col width="10%">
        <col width="10%">
        <col width="35%">
        <col width="10%">
        <col width="35%">
        </colgroup>
        <tbody>
        <tr>
        <td colspan="5" class="topbg"></td>
        </tr>
        <tr>
            <th rowspan="3" scope="row">담당자</th>
            <th class="dep2" scope="row">요청자</th>
            <td>
                <c:if test="${register.mrReqNo==0}">
                    <c:out value="${register.loginTeamName}"/> / <c:out value="${register.loginDutyName}"/> / <c:out value="${register.loginEmpName}"/>
                </c:if>
                <c:if test="${register.mrReqNo > 0}">
                    <span class="managerText"></span>
                </c:if>
                <input type="hidden" class="managerValue" name="appLine[0].chrgEmpNo" value="<c:out value="${register.loginEmpNo}"/>"/>
                <input type="hidden" class="managerDutyText" name="appLine[0].thdayPos" value="<c:out value="${register.loginDutyName}"/>"/>
                <input type="hidden" class="managerTeamText" name="appLine[0].thdayTeam" value="<c:out value="${register.loginTeamName}"/>"/>
                <input type="hidden" class="managerTeamValue" name="appLine[0].chrgTeamNo" value="<c:out value="${register.loginTeamNo}"/>"/>
                <input type="hidden" class="chrgrClCd" name="appLine[0].chrgrClCd" value="Z02A" data-role="manager"/>
                <input type="hidden" name="appLine[0].procTrmDt" value="9999-12-31" readOnly/>
            </td>
            <th scope="row">작성일</th>
            <td><span class="managerDate"></span></td>
        </tr>
        <tr>
            <th class="dep2" scope="row">승인<span style="color:red">&nbsp;*</span></th>
            <td colspan="3">
                <div class="form_group AAA" style="display:none">승인자 추가 :
                    <input type="text" class="i_input agreeText" readOnly/>
                    <input type="hidden" class="agreeValue" />
                    <input type="hidden" class="agreeDutyText"/>
                    <input type="hidden" class="agreeTeamText"/>
                    <input type="hidden" class="agreeTeamValue"/>
                    <img src="images/icon_search.png" class="cursor empSearch AAA" data-role="agree" style="display:none"/>
                    <img src="images/btn_app_add.gif" class="cursor empAdd AAA" style="display:none"/>
                </div>
            <table id="appLine" class="table_row" border="1" cellspacing="0">
            <c:if test="${modeClass=='AAA'}">
              <colgroup>
              <col width="10%">
              <col width="10%">
              <col width="35%">
              <col width="35%">
              <col width="10%">
              </colgroup>
            </c:if>
            <c:if test="${modeClass!='AAA'}">
              <colgroup>
              <col width="10%">
              <col width="45%">
              <col width="45%">
              </colgroup>
            </c:if>

                <thead>
                    <tr>
						<th class="AAA" style="display:none">순서변경</th>
						<th class="">승인순서</th>
						<th class="">승인자</th>
						<th class="">승인일</th>
						<th class="AAA" style="display:none">삭제</th>
                    </tr>
                 </thead>
                 <tbody>
                    <tr>
                    </tr>
					<!--
					 - 20170515
					 - wj
					 - 승인완료시 승인순서 란에 승인완료로 표시되어야 하는데 마지막 건에서 안되는 현상 발생
					 - 로직: 
					 - 원인: 조건 불일치
					 - 파람: 승인완료일시 chrgrClCd=null, fstProcTrmDt
					 - 수정: 
					-->					
                      <c:forEach var='appLine' items='${register.appLine}' varStatus="loop">
                      <c:if test="${appLine.chrgrClCd == 'Z02C' || appLine.chrgrClCd == 'Z02B'}">
                         <tr>						 
                          <td class="AAA" style="display:none">
                              <img src="images/arrow_up.png" width="8" height="8" class="appUp">
                              <img src="images/arrow_down.png" width="8" height="8" class="appDown">
                          </td>
                          <td>
							<c:if test="${appLine.fstProcTrmDt != null }">
								<c:set var="appLineCount" value="${appLineCount+1}"/>
								<c:out value="${appLineCount}"/>
							</c:if>
							<c:if test="${appLine.fstProcTrmDt == null }">
								승인완료
							</c:if>
                          </td>
                          <td>
                              <div class="form_group">
                                  <span class="tempText"><c:out value="${appLine.chrgEmpName}"/></span>
                                  <input type="hidden" class="tempValue" value="<c:out value="${appLine.chrgEmpNo}"/>"/>
                                  <input type="hidden" class="tempCode" value="Z02C"/>
                                  <input type="hidden" class="tempDutyText" value="<c:out value="${appLine.thdayPos}"/>"/>
                                  <input type="hidden" class="tempTeamText" value="<c:out value="${appLine.thdayTeam}"/>"/>
                                  <input type="hidden" class="tempTeamValue" value="<c:out value="${appLine.chrgTeamNo}"/>"/>
                                  <input type="hidden" class="tempProcStCd" value="<c:out value="${appLine.procStCd}"/>"/>
                              </div>
                          </td>
                          <td>
                              <div class="form_group">
                                <c:if test="${modeClass=='AAA'}">
                                  <input type="text" class="i_input inputDate limitDate" value="<fmt:formatDate value='${appLine.fstProcTrmDt}' pattern='yyyy-MM-dd' />" readOnly/>
                                </c:if>
                                <c:if test="${appLine.fstProcTrmDt != null }">
                                   승인기한 : <fmt:formatDate value='${appLine.fstProcTrmDt}' pattern='yyyy-MM-dd' />(결재중)
                                </c:if>

                                <c:if test="${appLine.fstProcTrmDt == null }">
                                   <fmt:formatDate value='${appLine.lastChgDt}' pattern='yyyy-MM-dd' />
                                </c:if>
                              </div>
                          </td>
                          <td class="AAA" style="display:none">
                              <img src="images/icon_minus.png" class="remove"/>
                          </td>
                        </tr>
                        </c:if>
                        </c:forEach>
                </tbody>
            </table>
            </td>
        </tr>
        <tr>
            <th class="dep2" scope="row">기술검토자지정<span style="color:red">&nbsp;*</span></th>
            <td colspan="3">
                <div class="form_group">
                <c:if test="${modeClass!='AAA'}"><span class="techText"></span></c:if>
                <c:if test="${modeClass=='AAA'}"><input type="text" class="i_input techText" readOnly/></c:if>
                <input type="hidden" class="techValue" name="appLine[3].chrgEmpNo" />
                <input type="hidden" class="techCode" name="appLine[3].chrgrClCd" value="Z02D"/>
                <input type="hidden" class="techDutyText" name="appLine[3].thdayPos" />
                <input type="hidden" class="techTeamText" name="appLine[3].thdayTeam" />
                <input type="hidden" class="techTeamValue" name="appLine[3].chrgTeamNo" />
                <img src="images/icon_search.png" class="cursor empSearch AAA" data-role="tech" style="display:none"/>
                </div>
            </td>
        </tr>
	     <tr>
	        <th rowspan="2">수행팀(설계팀)</th>
	        <th scope="row">팀장<span style="color:red">&nbsp;*</span></th>
	        <td colspan="3">
	              <div class="form_group">
	              <c:if test="${modeClass!='AAA'}"><span class="actionText"></span></c:if>
	              <c:if test="${modeClass=='AAA'}"><input type="text" class="i_input actionText" readOnly/></c:if>
	              <input type="hidden" class="actionValue" name="appLine[5].chrgEmpNo" />
	              <input type="hidden" class="actionCode" name="appLine[5].chrgrClCd" value="Z02G"/>
	              <input type="hidden" class="actionDutyText" name="appLine[5].thdayPos" />
	              <input type="hidden" class="actionTeamText" name="appLine[5].thdayTeam" />
	              <input type="hidden" class="actionTeamValue" name="appLine[5].chrgTeamNo" />
	              <img src="images/icon_search.png" class="vam cursor empSearch AAA" data-role="action" style="display:none"/>
	              </div>
	        </td>
	    </tr>
        <tr>        	
            <th class="dep2" scope="row">직책과장<img id="addEmp" src="images/icon_s_plus.png" border="0" class="cursor AAA" style="display:none"/></th>
            <td colspan="3">
                <table id="empLine">
                    <tr style="display:none"><td></td></tr>
                </table><span style="color:blue">* 수행팀이 설계1,2팀인 경우 설계1,2,3,4과장 4명 모두 필수 입력할 것</span>
            </td>
        </tr>		
		<!-- wj:2017-11 임시번호 display -->
        <tr>
            <th colspan="2" scope="row">MR임시 번호</th>
            <td colspan="3">
            	<div class="form_group">
	                <c:if test="${modeClass!='AAA'}">
	                    <c:out value="${register.mrTmpNo}"/>
	                </c:if>            	
            	</div>
            </td>
        </tr>
             
        <tr>
            <th colspan="2" scope="row">사 업 명<span style="color:red">&nbsp;*</span></th>
            <td colspan="3">
                <div class="form_group">
                <c:if test="${modeClass=='AAA'}">
                    <input type="text" class="i_input_full mrReqTitle" name="mrReqTitle" value="<c:out value="${register.mrReqTitle}"/>"/>
                </c:if>
                <c:if test="${modeClass!='AAA'}">
                    <c:out value="${register.mrReqTitle}"/>
                </c:if>
                </div>
            </td>
        </tr>
        <tr>
            <th colspan="2" scope="row">개선대상<span style="color:red">&nbsp;*</span></th>
            <td class="vat unit">
                <div class="in_search">
                    플랜트: <select class="plantNo AAA" name="plant" disabled="disabled"></select>
                </div>
                <div class="in_search_lp">
                    <img src="images/icon_search.png" class="cursor unitSearch AAA" style="display:none"/>
                </div>
                <div id="unitDiv" class="in_search">
                    <table id="selectUnit" class="table_default">
                    <c:forEach var="proc" items="${register.procs}" varStatus="loop">
                        <tr>
                          <td><c:out value="${proc.mrProcNo}"/><input type="hidden" class="procNo" name="procs[${loop.index}].mrProcNo" value="${proc.mrProcNo}"></td>
                          <td><c:out value="${proc.mrProcName}"/><input type="hidden" class="mrProcName" name="procs[${loop.index}].mrProcName" value="${proc.mrProcName}"></td>
                        <tr>
                    </c:forEach>
                    </table>
                </div>
             </td>
            <th scope="row">관련설비<span style="color:red">&nbsp;*</span></th>
            <td class="vat">
                <div class="in_search">
                    <img src="images/icon_search.png" class="cursor equipSearch AAA" style="display:none"/>
                </div>
                <div id="equipDiv" class="in_search">
                    <table id="selectEquip" class="table_default">
                      <c:forEach var="equip" items="${register.equips}" varStatus="loop">
                        <tr>
                          <td><c:out value="${equip.mrEquipCd}"/><input type="hidden" class="equipCd" name="equips[${loop.index}].mrEquipCd" value="${equip.mrEquipCd}"><span>&nbsp;</span><input type="hidden" class="equipProcNo" name="equips[${loop.index}].mrProcNo" value="${equip.mrProcNo}"></td>
                          <td><c:out value="${equip.mrEquipName}"/><input type="hidden" class="equipName" name="equips[${loop.index}].mrEquipName" value="${equip.mrEquipName}"></td>
                        <tr>
                      </c:forEach>
                    </table>
                </div>
            </td>
        </tr>
        <tr>
            <th colspan="2" scope="row">요청구분<span style="color:red">&nbsp;*</span></th>
            <td><select class="reqClCd AAA" name="reqClCd" disabled="disabled"></select> <select class="reqClDtlCd AAA" name="reqClDtlCd" disabled="disabled"></select></td>
            <th scope="row">작업시점<span style="color:red">&nbsp;*</span></th>
            <td>
                <div class="form_group">
                <select class="workPsblClCd AAA" name="workPsblClCd" disabled="disabled"></select>
                <c:if test="${modeClass=='AAA'}">
                    <input type="text" name="workPsblClRsn" class="i_input_200" value="<c:out value='${register.workPsblClRsn}'/>" placeholder="YYYY-MM-DD ~ YYYY-MM-DD"/>
                </c:if>
                <c:if test="${modeClass!='AAA'}">
                    <c:out value='${register.workPsblClRsn}'/>
                </c:if>

                </div>
            </td>
        </tr>
        <tr>
            <th scope="row">임시변경</th>
            <th class="dep2" scope="row">원상복구 책임자</th>
            <td>
                <div class="form_group">
                <c:if test="${modeClass!='AAA'}"><span class="tempsText"></span></c:if>
                <c:if test="${modeClass=='AAA'}"><input type="text" class="i_input tempsText" name="appLine[4].empName" readOnly disabled="disabled"/></c:if>
                <input type="hidden" class="tempsValue" name="appLine[4].chrgEmpNo" />
                <input type="hidden" class="tempsCode" name="appLine[4].chrgrClCd" value="Z02E"/>
                <input type="hidden" class="tempsDutyText" name="appLine[4].thdayPos" />
                <input type="hidden" class="tempsTeamText" name="appLine[4].thdayTeam" />
                <input type="hidden" class="tempsTeamValue" name="appLine[4].chrgTeamNo" />
                <img src="images/icon_search.png" class="cursor empSearch" data-role="temps" style="display:none"/>
                </div>
            </td>
            <th scope="row">원상복구기한</th>
            <td>
                <div class="form_group">
                <c:if test="${modeClass!='AAA'}"><span class="tempsEmptyDate"></span></c:if>
                <c:if test="${modeClass=='AAA'}">
                    <input type="text" name="appLine[4].procTrmDt" class="i_input inputLimitDate tempsEndDate" value="" data-role="+3" readOnly disabled="disabled"/>
                </c:if>
                <c:if test="${modeClass!='AAA'}">
                     <input type="hidden" name="appLine[4].procTrmDt" class="tempsEndDate" value=""/>
                </c:if>
                </div>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- space non 10 -->
    <hr class="divider_none_10" />

    <table class="table_row" border="1" cellspacing="0">
        <caption class="blind"></caption>
        <colgroup>
        <col width="10%">
        <col width="10%">
        <col width="10%">
        <col width="70%">
        </colgroup>
        <tbody>
        <tr>
            <th rowspan="8" scope="row">배경<br />및<br />현황</th>
            <th class="dep2" colspan="2">문제내용<span style="color:red">&nbsp;*</span></th>
            <td>
                <div class="form_group">
                <c:if test="${modeClass=='AAA'}">
                    <textarea name="issueCtt" rows="" cols="" class="i_text_full issueCtt"><c:out value="${register.issueCtt}"/></textarea>
                </c:if>
                <c:if test="${modeClass!='AAA'}">
                    <pre><c:out value="${register.issueCtt}"/></pre>
                </c:if>
                </div>
            </td>
        </tr>
        <tr>
            <th rowspan="5" class="dep2" scope="row">문제<br />개선</th>
            <th class="dep3" scope="row">발생 시점</th>
            <td><div class="form_group occPt"></div></td>

        </tr>
        <tr>
            <th class="dep3" scope="row">추정 원인</th>
            <td><div class="form_group preRsn"></div></td>
        </tr>
        <tr>
            <th class="dep3" scope="row">현재 운전</th>
            <td><div class="form_group curDrv"></div></td>
        </tr>
        <tr>
            <th class="dep3" scope="row">문제 발생<br />가능성</th>
            <td><div class="form_group probOcc"></div></td>
        </tr>
        <tr>
            <th class="dep3" scope="row">손실/영향</th>
            <td>
                <div class="form_group">
                <c:if test="${modeClass=='AAA'}">
                    <textarea name="inflnceLoss" rows="" cols="" class="i_text_full"><c:out value="${register.inflnceLoss}"/></textarea>
                </c:if>
                <c:if test="${modeClass!='AAA'}">
                    <pre><c:out value="${register.inflnceLoss}"/></pre>
                </c:if>
                </div>
            </td>
        </tr>
        <tr>
            <th rowspan="2" class="dep2" scope="row">운전/정비<br />불편관련</th>
            <th class="dep3" scope="row">불편사항</th>
            <td>
                <div class="form_group">
                <c:if test="${modeClass=='AAA'}">
                    <textarea name="incnvCtt" rows="" cols="" class="i_text_full"><c:out value="${register.incnvCtt}"/></textarea>
                </c:if>
                <c:if test="${modeClass!='AAA'}">
                    <pre><c:out value="${register.incnvCtt}"/></pre>
                </c:if>
                </div>
            </td>
        </tr>
        <tr>
            <th class="dep3" scope="row">사용빈도</th>
            <td>
                <div class="form_group">
                <c:if test="${modeClass=='AAA'}">
                    <input type="text" class="i_input num number" name="useCnt" value="<fmt:formatNumber value="${register.useCnt}" groupingUsed="true"/>"/>
                </c:if>
                <c:if test="${modeClass!='AAA'}">
                    <fmt:formatNumber value="${register.useCnt}" groupingUsed="true"/>
                </c:if>
                회 / <select class="useCntPrd AAA" name="useCntPrd"  disabled="disabled"></select>
                </div>
            </td>
        </tr>
        <tr>
            <th rowspan="3" scope="row">개선제안</th>
            <th colspan="2" class="dep2" scope="row">제안/변경 사항</th>
            <td>
                <div class="form_group">
                <c:if test="${modeClass=='AAA'}">
                    <textarea name="imprvPrpslCtt" rows="" cols="" class="i_text_full"><c:out value="${register.imprvPrpslCtt}"/></textarea>
                </c:if>
                <c:if test="${modeClass!='AAA'}">
                    <pre><c:out value="${register.imprvPrpslCtt}"/></pre>
                </c:if>
                </div>
            </td>
        </tr>
        <tr>
            <th rowspan="2" class="dep2" scope="row">기대효과</th>
            <th class="dep3" scope="row">정량적효과</th>
            <td>
                <div class="form_group">
                <c:if test="${modeClass=='AAA'}">
                    <input type="text" class="i_input num number" name="quanEptEftCtt" value="<fmt:formatNumber value="${register.quanEptEftCtt}" groupingUsed="true"/>"/>
                </c:if>
                <c:if test="${modeClass!='AAA'}">
                    <fmt:formatNumber value="${register.quanEptEftCtt}" groupingUsed="true"/>
                </c:if>
                 <select class="qnUnit AAA" name="quanEptEftCd"  disabled="disabled"></select>
                </div>
            </td>
        </tr>
        <tr>
            <th class="dep3" scope="row">정성적효과</th>
            <td>
                <div class="form_group">
                <c:if test="${modeClass=='AAA'}">
                    <textarea name="qualEptEftCtt" rows="" cols="" class="i_text_full"><c:out value="${register.qualEptEftCtt}"/></textarea>
                </c:if>
                <c:if test="${modeClass!='AAA'}">
                    <pre><c:out value="${register.qualEptEftCtt}"/></pre>
                </c:if>
                </div>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- space non 10 -->
    <hr class="divider_none_10" />

    <table class="table_row" id="file" border="1" cellspacing="0">
        <caption class="blind"></caption>
        <colgroup>
        <col width="10%">
        <col width="90%">
        </colgroup>
        <tbody>
        <tr>
        <th scope="row" class="vam fileAdd">첨부파일
          <img id="addFile" src="images/icon_s_plus.png" border="0" class="cursor AAA addFile" style="display:none"/>
        </th>
        <td class="section_text pl5 pt5 pb5" colspan="3">
          <div class="form_group">
            <table id="fileList" class="table_default_margin" border="1" cellspacing="0">
              <tr style="display:none"><td></td></tr>
              <c:forEach var="mrAtchFiles" items="${register.mrAtchFiles}" varStatus="loop">
              <tr>
                 <td>
                  <input type="text" class="i_input" value="${mrAtchFiles.fileCdNm}" readonly>
                  <input type="text" class="i_input_300" value="${mrAtchFiles.fileNm}" readonly>
                  <input type="file" multiple webkitdirectory class="directorySelector"/>
                  <img src="images/btn_inFile.png" class="cursor fileDown"/>
                  <img class="cursor AAA removeDownFile" src="images/icon_minus.png" style="display:none"/>
                  <input type="hidden" value="${mrAtchFiles.fileCd}"/>
                  <input type="hidden" class="delFlag" name="mrAtchFiles[${loop.index}].deleted" value="false"/>
                  <input type="hidden" class="insFlag" name="mrAtchFiles[${loop.index}].inserted" value="false"/>
                  <input type="hidden" name="mrAtchFiles[${loop.index}].mrAtchFileNo" value="${mrAtchFiles.mrAtchFileNo}"/>
                  <input type="hidden" class="drawMngNo" name="mrAtchFiles[${loop.index}].drawMngNo" value="${mrAtchFiles.drawMngNo}"/>
                </td>
              </tr>
            </c:forEach>
            </table>
          </div>
        </td>
        </tr>
        </tbody>
    </table>
</form>
</div>


<table id="appLineTemp" style="display:none">
   <tr>
    <td style="align:center">
        <img src="images/arrow_up.png" width="8" height="8" class="appUp">
        <img src="images/arrow_down.png" width="8" height="8" class="appDown">
    </td>
    <td></td>
    <td>
        <div class="form_group">
            <span class="tempText"></span>
            <input type="hidden" class="tempValue" name=""/>
            <input type="hidden" class="tempCode" name="" value="Z02C"/>
            <input type="hidden" class="tempDutyText" name=""/>
            <input type="hidden" class="tempTeamText" name=""/>
            <input type="hidden" class="tempTeamValue" name=""/>
        </div>
    </td>
    <td>
        <div class="form_group">
            <input type="text" class="i_input limitDate" value="" readOnly  name=""/>
        </div>
    </td>
    <td>
        <img src="images/icon_minus.png" class="remove"/>
    </td>
  </tr>
</table>

    <table id="empTemp" style="display:none">
        <tr>
            <td style="border:0px;padding:0px;margin:0px;">
                <div class="form_group">
                <c:if test="${modeClass!='AAA'}"><span class="tempText empText" style="border:0px;"></span></c:if>
                <c:if test="${modeClass=='AAA'}"><input type="text" class="i_input tempText empText" readOnly/></c:if>
                <input type="hidden" class="tempValue empValue" name="appLine[6].chrgEmpNo" />
                <input type="hidden" class="tempCode empCode" name="appLine[6].chrgrClCd" value="Z02G1"/>
                <input type="hidden" class="tempDutyText empDuty" name="appLine[6].thdayPos" />
                <input type="hidden" class="tempTeamText empTeam" name="appLine[6].thdayTeam" />
                <input type="hidden" class="tempTeamValue empTeamValue" name="appLine[6].chrgTeamNo" />
                <img src="images/icon_search.png" class="cursor empSearch AAA" data-role="temp" style="display:none"/>
                <img class="cursor removeEmp AAA" src="images/icon_minus.png" style="display:none"/>
                </div>
            </td>
        </tr>
    </table>

<script>
var empCount= 0;
$(window).ready(function() {
	var checkList = new Array();
	var appClass= "";
	var disabled = true;    

	if("${modeClass}"=="AAA"){
		disabled = false;
	}
	
	

	"<c:forEach var='issue' items='${register.issues}'>";
	   checkList.push("${issue.issueCd}"+'');
	"</c:forEach>";

	
	
	"<c:forEach var='appLine' items='${register.appLine}'>";
	//alert("${appLine.chrgrClCd}"); 2017-05-15
	
		switch ("${appLine.chrgrClCd}") {
		case "Z02A":
			appClass = "manager";
			break;
	    case "Z02B":
	    	appClass = "agree";
	        break;
	    case "Z02C":
	    	appClass = "app";
	        break;
	    case "Z02D":
	    	appClass = "tech";
	        break;
	    case "Z02E":
	    	appClass = "temps";
	        break;
	    case "Z02G":
	        appClass = "action";
	        break;
	    case "Z02G1":
	        appClass = "emp";
	        break;
	    }
		
	    if(appClass == "emp") {	
	        $("#addEmp").click();
	        $.sortIndex();
	        appClass = "empLine"+empCount;
	    }
		
	    $.appLineSet({className:appClass, dutyText:"${appLine.thdayPos}",
	        text:"${appLine.chrgEmpName}", value:"${appLine.chrgEmpNo}",
	        teamText:"${appLine.thdayTeam}" , teamValue:"${appLine.chrgTeamNo}",
	        endDate:"<fmt:formatDate value='${appLine.fstProcTrmDt}' pattern='yyyy-MM-dd' />",
	        date:"<fmt:formatDate value='${appLine.lastChgDt}' pattern='yyyy-MM-dd' />"});
    "</c:forEach>";

    //요청구분
    $.selectLoad({
        className : "reqClCd",
        url : "codeList.do?mrCommGrpCd=REQ",
        defaultText : "전체",
        selectValue : "${register.reqClCd}"+""
    });

	//요청구분 상세
    $.selectLoad({
        className : "reqClDtlCd",
        url : "codeList.do?mrCommGrpCd=REQ_DET&parentCd=${register.reqClCd}",
        defaultText : "선택",
        selectValue : "${register.reqClDtlCd}"+""
    });

    $.selectLoad({
        className : "workPsblClCd",
        url : "codeList.do?mrCommGrpCd=WORK",
        defaultText : "선택",
        selectValue : "${register.workPsblClCd}"
    });

    $.selectLoad({
        className : "qnUnit",
        url : "codeList.do?mrCommGrpCd=QN_UNIT",
        defaultText : "선택",
        selectValue : "${register.quanEptEftCd}"
    });

    $.selectLoad({
        className : "plantNo",
        url : "codeList.do?mrCommGrpCd=PLANT",
        defaultText : "선택",
        selectValue : "${register.plant}"
    });   

    $.checkLoad({
        className : "occPt",
        setClass : "issue",
        url : "codeList.do?mrCommGrpCd=OCC_PT",
        fristName:"issues",
        lastName:"issueCd",
        //isDisabled : disabled,
        isBr:true,
        checkValue:checkList
    });

    $.checkLoad({
        className : "preRsn",
        setClass : "issue",
        url : "codeList.do?mrCommGrpCd=PRE_RSN",
        fristName:"issues",
        lastName:"issueCd",
        isDisabled : disabled,
        isBr:true,
        checkValue:checkList
    });

    $.checkLoad({
        className : "curDrv",
        setClass : "issue",
        url : "codeList.do?mrCommGrpCd=CUR_DRV",
        fristName:"issues",
        lastName:"issueCd",
        isDisabled : disabled,
        isBr:true,
        checkValue:checkList
    });

    $.checkLoad({
        className : "probOcc",
        setClass : "issue",
        url : "codeList.do?mrCommGrpCd=PROB_OCC",
        fristName:"issues",
        lastName:"issueCd",
        isDisabled : disabled,
        isBr:true,
        checkValue:checkList
    });

    $.selectLoad({
        className : "useCntPrd",
        url : "codeList.do?mrCommGrpCd=QN_UNIT",
        defaultText : "선택",
        selectValue : "${register.useCntPrd}"
    });

    $(".inputLimitDate").datepicker({
        dateformat:"yyyy-mm-dd",
        showOn:"button",
        changeYear: true,
        changeMonth: true,
        buttonImage:"images/icon_calendar.png",
        buttonImageOnly:true,
        minDate :"today",
        maxDate :"+3M"
    });
    $("img.ui-datepicker-trigger").attr("style", "border=0;cursor:Pointer;vertical-align:middle;margin-left: 4px;margin-right: 4px;");
    $(".ui-datepicker-month").attr("width", "30px");

    $(".tempsEndDate").parent("div").children(".ui-datepicker-trigger").hide();
    
    //alert("${register.reqClCd}"); //2017-05-15
    if("${register.reqClCd}"=="0006" && "${modeClass}"=="AAA") {
        $(".tempsText").parent("div").parent("tr").children("td:last").children(".ui-datepicker-trigger").show();
        $(".tempsText").parent("div").children("img").show();
        $(".tempsEndDate").parent("div").children("img").show();
        $(".tempsEndDate").attr("disabled",false);
        $(".tempsText").attr("disabled",false);
    };

    var currentDate = $.getCurrentDate();

    if($("#writeDate").html()=="") {
        $("#writeDate").html(currentDate);
    }

    //사원조회 팝업창
	$(document).on("click",".empSearch",function() {
		$.popup({url:"popup/empSearch.do", width:"500", height:"500", targetName:$(this).attr("data-role")});
    });

	$(".plantNo").change(function(){
	    $("#selectUnit").find("tr").remove().end();
	    $("#selectEquip").find("tr").remove().end();
	});

	$.sortUintList = function(option){
		$.sort({className : "mrProcNo", fristName : "procs", lastName : "mrProcNo"});
		$.sort({className : "mrProcName", fristName : "procs", lastName : "mrProcName"});
	};

    $.sortEquipList = function(option){
        $.sort({className : "procNo", fristName : "equips", lastName : "mrProcNo"});
        $.sort({className : "equipName", fristName : "equips", lastName : "mrEquipName"});
        $.sort({className : "equipCd", fristName : "equips", lastName : "mrEquipCd"});
    };

    $(".save").click(function () {
        $.sort({className : "issue", fristName : "issues", lastName : "issueCd"});
        $.sortIndex();
        if($.validation())
       
        if(confirm("저장 하시겠습니까?")) {
        	$.removeComma();
            $('#pageLoadingWrap').show();
            $("form").attr("action", "${saveURL}").submit();
        }
    });

    $(".appReq").click(function () {
        $.sort({className : "issue", fristName : "issues", lastName : "issueCd"});
        $.sortIndex();
        if($.validation())
        if(confirm("승인요청 하시겠습니까?")) {
    		$.removeComma();
    		$('#pageLoadingWrap').show();
            $("form").attr("action", "mrRqRegisterAppReq.do").submit(); 
    	}
    });

    $(".app").click(function () {
        if(confirm("승인 하시겠습니까?")) {
            $('#pageLoadingWrap').show();
            $("form").attr("action", "${appURL}").submit();
        }
    });

    $(".return").click(function () {
        if(confirm("반려 하시겠습니까?")) {
            $('#pageLoadingWrap').show();
            $("form").attr("action", "mrRqRegisterReturn.do").submit();
        }
    });

    $(".cancel").click(function () {
        if(confirm("사업취소 하시겠습니까?")) {
            $('#pageLoadingWrap').show();
            $("form").attr("action", "mrRqRegisterCancel.do").submit();
        }
    });

    $.validation = function(){
    	var isValid = false;
    	var isValidct = 0;
    	var appCnt = 0;
        $("#appLine").children("tbody").children("tr").each(function() {
            if($(this).children("td:eq(2)").children("div").find(".tempValue").val() != ""){
            	appCnt++;
            }
         });

        if(appCnt<3){
        	isValid = false;
        	alert("승인자는 최소 2명이상 입력하여야 합니다.");
        	isValidct = isValidct + 1;
        } else if (appCnt>2) {
        	isValid = true;
        }

        if(isValid){
        	isValid = false;
        	isValid = $.validator({
                        techText : {method:"class",type:"text", msg:"기술검토자를 입력하세요."},
                        actionText: {method:"class",type:"text", msg:"수행팀 팀장을 입력하세요."}
                    });
        }

        var actAppCnt = 0;
        $("#empLine").children("tbody").children("tr:gt(0)").each(function() {
        	if($(this).children("td").children("div").children(".empValue").val() !=""){
            	actAppCnt++;
        	}
        });
        
        if(actAppCnt<1){
        	isValid = false;
        	alert("수행팀 직책과장을 최소1명이상 입력하여야 합니다.");
        	isValidct = isValidct + 1;
        } else if (actAppCnt>0) {
        	isValid = true;
        }

        if(isValid){
        	isValid = false;
        	isValid = $.validator({
                        mrReqTitle : {method:"class",type:"text", msg:"사업명을 입력하세요."},
                        plantNo : {method:"class",type:"select", msg:"플랜트를 선택하세요."},
                        selectUnit : {method:"id",type:"list", focus:"unitDiv", msg:"공정을 선택하세요."},
                        selectEquip : {method:"id",type:"list", focus:"equipDiv", msg:"설비를 선택하세요."},
                        reqClCd : {method:"class",type:"select", msg:"요청구분을 선택하세요."},
                        occPt : {method:"id",type:"check", msg:"발생 시점을 선택하세요."},
                        preRsn : {method:"id",type:"check", msg:"추정 원인을 선택하세요."},
                        curDrv : {method:"id",type:"check", msg:"현재 운전을 선택하세요."},
                        probOcc : {method:"id",type:"check", msg:"문제 발생 가능성을 선택하세요."}                        
                    });
        }

        //if($("#occPt:checked").length < 1){
        //	alert("발생 시점을 선택하세요.");
        //	return false;
        //}
        if(isValid && $(".reqClCd").val()!="0006") {
    	      isValid = $.validator({
    	    	  reqClDtlCd : {method:"class",type:"select", msg:"요청구분 상세를 선택하세요."}
              });

    	}

    	if(isValid && $(".reqClCd").val()=="0006") {
          isValid = $.validator({
        	  tempsText : {method:"class",type:"text", msg:"원상복구 책임자를 입력하세요."},
        	  tempsEndDate : {method:"class",type:"text", msg:"원상복구기한을 입력하세요."}
          });
    	}

        if(isValid) {
            isValid = $.validator({
                workPsblClCd : {method:"class",type:"select", msg:"작업시점을 선택하세요."},
                issueCtt : {method:"class",type:"text", msg:"문제내용을 입력하세요."}
            });
          }
        
        if(isValidct > 0){
        	isValid = false;
        }
        
        return isValid;
    };

    //if("${modeClass}"=="AAA"){
        $.sortIndex();
    //}
    
    /***************************************
    * hajewook 추가
    * 기안 로직 
    ***************************************/
    

    if("${mrAction}" == "mrRqRegisterAppReq"){
    	//alert("기안로직");
    	//alert("fstRgstr:"+ "${register.fstRgstr}"+"|w|||"+"mrReqNo"+ "${register.mrReqNo}");
        var url = "http://gian.oilbank.co.kr/connlogin.aspx?"  
            + "&uid="      + "${register.fstRgstr}"
            + "&connkey="  + "${register.mrReqNo}"
            + "&connType=" + "WEB"
            + "&connName=" + "MR"
            + "&connCode=" + "Z0010"
            + "&endTime="  + "DRAFT"
            + "&auto="     + "N";
        window.open(url, "mrRqRegisterAppReq");
    }
});


/***************************************
 * hajewook 추가
 * 기안 로직 
 ***************************************/
/*hajewook 재상신*/
$(document).on("click", ".reAppReq", function() {
	alert("재상신 기안로직");
	
   var url = "http://gian.oilbank.co.kr/connlogin.aspx?" 		   
       + "&uid="      + "${register.fstRgstr}"
       + "&connkey="  + "${register.mrReqNo}"
       + "&connType=" + "WEB"
       + "&connName=" + "MR"
       + "&connCode=" + "Z0010"
       + "&endTime="  + "DRAFT"
       + "&auto="     + "N";
   window.open(url, "mrRqRegisterAppReq");
});

$(document).on("click",".unitSearch", function () {
	if($(".plantNo").val()=="") {
		alert("플랜트를 선택하세요.");
		return;
	}

    $.popup({url:"popup/unitSearch.do?"+$("form").serialize()+"&plantNo="+$(".plantNo").val() +"&plantName="+$(".plantNo option:selected").text(), width:"880", height:"500"});
    $("#selectUnit").find("tr").remove().end();
    /* $("#selectEquip").find("tr").remove().end(); */
});

$(document).on("click",".equipSearch", function () {
	var count = 0;
	$("#selectUnit").children("tbody").children("tr").each(function(){
		count++;
	});
	if(count<1){
		alert("공정을 선택하세요.");
		return;
	}

    $.popup({url:"popup/equipSearch.do?"+$("form").serialize(), width:"880", height:"600"});
    $("#selectEquip").find("tr").remove().end();
});


$(document).on("change",".reqClCd", function () {
        $.selectLoad({
            className : "reqClDtlCd",
            url : "codeList.do?mrCommGrpCd=REQ_DET&parentCd="+$(this).val()
        });
        
        if($(this).val()=="0006") {
        	$(".tempsText").parent("div").parent("tr").children("td:last").children(".ui-datepicker-trigger").show();
        	$(".tempsText").parent("div").children("img").show();
        	$(".tempsEndDate").parent("div").children("img").show();
        	$(".tempsEndDate").attr("disabled",false);
        	$(".tempsText").attr("disabled",false);
        } else {
            $(".tempsText").parent("div").parent("tr").children("td:last").children(".ui-datepicker-trigger").hide();
            $(".tempsText").parent("div").children("img").hide();
            $(".tempsEndDate").parent("div").children("img").hide();
            $(".tempsEndDate").attr("disabled",true);
            $(".tempsText").attr("disabled",true);
            $(".reqClDtlCd").show();
        }
});

$(document).on("click",".empAdd", function () {

	      var empCnt = 0;
	      var div = "";
	      var date = null;
	      /*정보입력체크*/
	      if($(".agreeText").val()==""){
	          alert("승인자를 입력하세요.");
	          return;
	      }
	      /*사원중복체크*/
	      $("#appLine").children("tbody").children("tr").each(function() {
	         if($(this).children("td:eq(2)").children("div").find(".tempValue").val() == $(".agreeValue").val()){
	              empCnt++;
	         }
	      });


	      if(empCnt>0){
	    	  $(".agreeText").val("");
	    	  alert("이미 추가된 사원입니다.");
	          return;
	      }

	      if(empCnt<1){
	    	  div = $("#appLineTemp tbody").children("tr").children("td:eq(2)").children("div");
	    	  div.children(".tempText").html($(".agreeText").val());
	    	  div.children(".tempValue").val($(".agreeValue").val());
	    	  div.children(".tempDutyText").val($(".agreeDutyText").val());
	    	  div.children(".tempTeamText").val($(".agreeTeamText").val());
	    	  div.children(".tempTeamValue").val($(".agreeTeamValue").val());

	    	  $("#appLineTemp tr").clone().insertAfter($("#appLine tbody tr:last"));

 	          div.children(".tempText").html("");
	          div.children(".tempValue").val("");
	          div.children(".tempDutyText").val("");
	          div.children(".tempTeamText").val("");
	          div.children(".tempTeamValue").val("");


	          date = $("#appLine tbody tr:last").children("td:eq(3)").children("div");
	          date.children(".i_input").datepicker({
	                dateformat:"yyyy-mm-dd",
	                showOn:"button",
	                changeYear: true,
	                changeMonth: true,
	                buttonImage:"images/icon_calendar.png",
	                buttonImageOnly:true,
	                minDate: "today"
	            });
              var maxDate=0;
              var nowDate = new Date();
              switch (nowDate.getDay()) {
              case 0:
                  maxDate = 5;
                  break;
              case 6:
                  maxDate = 6;
                  break;
              default:
                  maxDate = 7;
                  break;
              }
              nowDate.setDate(nowDate.getDate()+maxDate);

              date.children(".i_input").datepicker("setDate",nowDate);

	          date.children("img.ui-datepicker-trigger").attr("style", "border=0;cursor:Pointer;vertical-align:middle;margin-left: 4px;margin-right: 4px;");
	          date.children(".ui-datepicker-month").attr("width", "30px");

	          $(".agreeText").val("");

	          $.sortIndex();

	      }
});

/* 직책과장 추가*/
$(document).on("click","#addEmp", function () {
    var empTemp = $("#empTemp").children("tbody").children("tr");
    empTemp.clone().insertAfter($("#empLine").children("tbody").children("tr:last"));
    $.sortIndex();
});

/* 직책과장 삭제*/
$(document).on("click", ".removeEmp", function() {
    $(this).parent("div").parent("td").parent("tr").remove();
    $.sortIndex();
});

/*결재라인 삭제*/
$(document).on("click", ".remove", function() {
    $(this).parent("td").parent("tr").remove();
    $.sortIndex();
});

/*결재라인 변경*/
$(document).on("click", ".appUp,.appDown", function(){
	var index = $(this).parent("td").parents("tr").index();
	var row = $("#appLine").children("tbody").children("tr").eq(index);

	 if ($(this).is(".appUp")) {
		 if(index==1)
			 return;
	     row.insertBefore(row.prev());
	     $.sortIndex();
	}else {
	    row.insertAfter(row.next());
	    $.sortIndex();
	}
});

$.sortIndex = function (){
    var totalAppline = 0;
    /* var agreeCnt = $("#Z02F tbody tr").length;
    var adjerCnt = $("#Z02G tbody tr").length; */

    //var totalAppline = parseInt(aprvrCnt)+parseInt(adjerCnt);
   //alert("aprvrCnt : " + aprvrCnt + ", agreeCnt: " + agreeCnt + ", adjerCnt : " + adjerCnt + ", totalAppline : " + totalAppline);   

    var empInfo = null;
    var appDate = null;	
	
        $("#appLine").children("tbody").children("tr").each(function() {
        	totalAppline = $(this).index();

			empInfo1 = $(this).children("td:eq(1)").children("div");
			
            empInfo = $(this).children("td:eq(2)").children("div");
            appDate = $(this).children("td:eq(3)").children("div");			
			
			//alert('asd1:' + empInfo1.children(".tempProcStCd").val());
			//alert('asd:' + empInfo.children(".tempProcStCd").val());			
			
            if(empInfo.children(".tempProcStCd").val()!="Z0121"){
				//2017-05-15 wj(완)
				//Z0121 승인요청값이 있을때 화면에 승인완료라고 처리함
				//alert('값 있을때 z0121_1:' + empInfo1.children(".tempProcStCd").val());
				//alert('값 있을때 z0121:' + empInfo.children(".tempProcStCd").val());
				
				//2017-05-15 wj 구문추가 null일때는 카운트 표시
				if(empInfo.children(".tempProcStCd").val()==null){
					$(this).children("td").eq(1).html(totalAppline);
				}
				
				
                //$(this).children("td").eq(1).html(totalAppline);
            }
			
            empInfo.children(".tempValue").attr("name","appLine["+totalAppline+"].chrgEmpNo");
            empInfo.children(".tempCode").attr("name","appLine["+totalAppline+"].chrgrClCd");
            empInfo.children(".tempDutyText").attr("name","appLine["+totalAppline+"].thdayPos");
            empInfo.children(".tempTeamText").attr("name","appLine["+totalAppline+"].thdayTeam");
            empInfo.children(".tempTeamValue").attr("name","appLine["+totalAppline+"].chrgTeamNo");

            appDate.children(".limitDate").attr("name","appLine["+totalAppline+"].procTrmDt");

        });	

        totalAppline++;
        $(".techValue").attr("name","appLine["+totalAppline+"].chrgEmpNo");
        $(".techCode").attr("name","appLine["+totalAppline+"].chrgrClCd");
        $(".techDutyText").attr("name","appLine["+totalAppline+"].thdayPos");
        $(".techTeamText").attr("name","appLine["+totalAppline+"].thdayTeam");
        $(".techTeamValue").attr("name","appLine["+totalAppline+"].chrgTeamNo");
        $(".techDate").attr("name","appLine["+totalAppline+"].procTrmDt");

        totalAppline++;
        $(".tempsValue").attr("name","appLine["+totalAppline+"].chrgEmpNo");
        $(".tempsCode").attr("name","appLine["+totalAppline+"].chrgrClCd");
        $(".tempsDutyText").attr("name","appLine["+totalAppline+"].thdayPos");
        $(".tempsTeamText").attr("name","appLine["+totalAppline+"].thdayTeam");
        $(".tempsTeamValue").attr("name","appLine["+totalAppline+"].chrgTeamNo");
        $(".tempsDate").attr("name","appLine["+totalAppline+"].procTrmDt");
        
        totalAppline++;
        $(".actionValue").attr("name","appLine["+totalAppline+"].chrgEmpNo");
        $(".actionCode").attr("name","appLine["+totalAppline+"].chrgrClCd");
        $(".actionDutyText").attr("name","appLine["+totalAppline+"].thdayPos");
        $(".actionTeamText").attr("name","appLine["+totalAppline+"].thdayTeam");
        $(".actionTeamValue").attr("name","appLine["+totalAppline+"].chrgTeamNo");
        $(".actionDate").attr("name","appLine["+totalAppline+"].procTrmDt");

        $.sortEmpLine(totalAppline);

};

$.sortEmpLine = function(count){
	var empDiv;
	$("#empLine").children("tbody").children("tr:gt(0)").each(function () {
		count++;
		empDiv = $(this).children("td").children("div");
		empDiv.find(".empValue").attr("name","appLine["+count+"].chrgEmpNo");
		empDiv.find(".empCode").attr("name","appLine["+count+"].chrgrClCd");
		empDiv.find(".empDuty").attr("name","appLine["+count+"].thdayPos");
		empDiv.find(".empTeam").attr("name","appLine["+count+"].thdayTeam");
		empDiv.find(".empTeamValue").attr("name","appLine["+count+"].chrgTeamNo");

        empDiv.find(".empText").attr("class","empLine"+count+"Text empText i_input");
        empDiv.find(".empValue").attr("class","empLine"+count+"Value empValue");
        empDiv.find(".empCode").attr("class","empLine"+count+"Code empCode");
        empDiv.find(".empDuty").attr("class","empLine"+count+"DutyText empDuty");
        empDiv.find(".empTeam").attr("class","empLine"+count+"TeamText empTeam");
        empDiv.find(".empTeamValue").attr("class","empLine"+count+"TeamValue empTeamValue");
        empDiv.find(".empSearch").attr("data-role","empLine"+count);
    	empCount = count;
	});
};
</script>