package com.mr.tech.controller;

import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;

import com.base.servlet.BaseController;
import com.mr.step.service.MrStepService;
import com.mr.tech.domain.TechReviewVO;
import com.mr.tech.service.MrCompleteService;

/**
 * 기술 및 타당성 검토 DB
 *
 * @author 박성룡
 * @version 1.0
 *
 *          <pre>
 * 수정일 | 수정자 | 수정내용
 * ---------------------------------------------------------------------
 * 2014.07.07 박성룡 최초 작성
 * </pre>
 */
@Controller
public class MrCompleteController  extends BaseController{
    private final Logger logger = Logger.getLogger(this.getClass());

    @Autowired
    MrCompleteService mrCompleteService;

    @Autowired
    MrStepService mrStepService;

    /**
     * MR 완료 페이지 (타당성검토확인 임시저장)
     * @param mrReqNo
     * @param model
     * @return
     */
    @RequestMapping(value = "/mrComplete.do")
    public String mrComplete(Integer mrReqNo, String mrAction, Model model){

        TechReviewVO techReviewVO = mrCompleteService.selectMrComplete(mrReqNo);
        String modeClass = mrStepService.getModeClass(mrReqNo);

        if(techReviewVO.getMrTechRvNo()==0) {
            model.addAttribute("saveURL","mrTechSave.do");
        } else {
            model.addAttribute("saveURL","mrTechUpdate.do");
        }

        if(modeClass.equals("CCA")) {
            model.addAttribute("appURL","mrCompleteAgree.do");
        } else if(modeClass.equals("CEA")) {
            model.addAttribute("appURL","mrCompleteApp.do");
        }
        model.addAttribute("techReview",techReviewVO);
        model.addAttribute("mrSteps",mrStepService.selectAllMrReqStep(mrReqNo));
        model.addAttribute("modeClass",modeClass);
        
        //hajewook 추가 승인요청 액션 저장 2015.09.08
        model.addAttribute("mrAction", mrAction);

        return "tech/mrCompleteRegister";
    }

    /**
     * MR 완료 내용 저장 (타당성검토확인 임시저장)
     * @param techReviewVO
     * @param model
     * @return
     */
    @RequestMapping(value = "/mrCompleteSave.do")
    public String mrCompleteSave(TechReviewVO techReviewVO, Model model){
        mrCompleteService.updateMrTechReview(techReviewVO);
        return "redirect:mrComplete.do?mrReqNo=" + techReviewVO.getMrReqNo();
    }

    /**
     * MR 완료 1차 승인 요청(타당성검토 승인요청)
     * @param techReviewVO
     * @param model
     * @return
     */    
    @RequestMapping(value = "/mrCompleteAppReq.do")
    public String mrCompleteAppReq(TechReviewVO techReviewVO, Model model){
    	//저장을 안하고 승인요청을 클릭할 수 있으므로 내부적으로 임시저장 후 승인요청 로직을 수행
        mrCompleteService.insertMrCompleteAppReq(techReviewVO);        
        
        //hajewook 추가 승인요청 액션 저장 2015.09.03  콜백시 승인요청 플래그값        
        return "redirect:mrComplete.do?mrReqNo=" + techReviewVO.getMrReqNo()+"&mrAction=mrCompleteAppReq";
    }

    /**
     * MR완료 1차 승인 및 2차 승인요청
     * @param techReviewVO
     * @param model
     * @return
     */
    @RequestMapping(value = "/mrCompleteAgree.do")
    public String mrCompleteAgree(TechReviewVO techReviewVO, Model model){
        mrCompleteService.insertMrCompleteAgree(techReviewVO.getMrReqNo());
        return "redirect:mrComplete.do?mrReqNo=" + techReviewVO.getMrReqNo();
    }

    /**
     * MR완료 2차 승인
     * @param techReviewVO
     * @param model
     * @return
     */
    @RequestMapping(value = "/mrCompleteApp.do")
    public String mrCompleteApp(TechReviewVO techReviewVO, Model model){
        mrCompleteService.insertMrCompleteApp(techReviewVO);
        return "redirect:mrComplete.do?mrReqNo=" + techReviewVO.getMrReqNo();
    }

    /**
     * MR완료 반려
     * @param techReviewVO
     * @param model
     * @return
     */
    @RequestMapping(value = "/mrCompleteReturn.do")
    public String mrCompleteReturn(TechReviewVO techReviewVO, Model model){
        mrCompleteService.insertMrTechReturn(techReviewVO);
        return "redirect:mrComplete.do?mrReqNo=" + techReviewVO.getMrReqNo();
    }

}
