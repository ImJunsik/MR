package com.mr.tech.controller;

import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;

import com.base.servlet.BaseController;
import com.mr.step.domain.ChrgrChgHist;
import com.mr.step.service.MrStepService;
import com.mr.tech.domain.TechInvestVO;
import com.mr.tech.domain.TechReviewVO;
import com.mr.tech.service.TechInvestService;
import com.mr.tech.service.TechService;

/**
 * 기술 및 타당성 검토 투자비산정
 *
 * @author 박성룡
 * @version 1.0
 *
 *          <pre>
 * 수정일 | 수정자 | 수정내용
 * ---------------------------------------------------------------------
 * 2014.07.07 박성룡 최초 작성
 * 2019.04    투자비 산정 반송로직 추가
 * </pre>
 */
@Controller
public class TechInvestController extends BaseController{
    private final Logger logger = Logger.getLogger(this.getClass());

    @Autowired
    TechInvestService techInvestService;

    @Autowired
    MrStepService mrStepService;

    @Autowired
    TechService techService;


    /**
     * 초기투자비 산정 페이지 조회
     * @param mrReqNo
     * @param model
     * @return
     */
    @RequestMapping(value = "/mrTechInvest.do")
    public String register(Integer mrReqNo, String mrAction, Model model){
        TechInvestVO techInvestVO = techInvestService.selectMrTechInvest(mrReqNo);
        model.addAttribute("techInvest",techInvestVO);
        model.addAttribute("mrSteps",mrStepService.selectAllMrReqStep(mrReqNo));
        model.addAttribute("modeClass",mrStepService.getModeClass(mrReqNo));
        model.addAttribute("mrAction",mrAction);//승인요청 상태값 저장
        
        return "tech/techInvestCostRegister";
    }

    /**
     * Project Engineer지정
     * @param techInvestVO
     * @param model
     * @return
     */
    @RequestMapping(value = "/mrTechInvestLineSet.do")
    public String mrTechInvestLineSet(TechInvestVO techInvestVO, Model model){
        techInvestService.insertMrTechInvestSetWriter(techInvestVO);
        return "redirect:mrTechInvest.do?mrReqNo=" + techInvestVO.getMrReqNo();
    }

    /**
     * 투자비 산정 저장(임시저장)
     * @param techInvestVO
     * @param model
     * @return
     */
    @RequestMapping(value = "/mrTechInvestSave.do")
    public String mrTechInvestSave(TechInvestVO techInvestVO, Model model){    	
        techInvestService.insertMrTechInvest(techInvestVO);
        return "redirect:mrTechInvest.do?mrReqNo=" + techInvestVO.getMrReqNo();
    }

    /**
     * 초기 투자비 산정 승인요청 버튼클릭 
     * @param techInvestVO
     * @param model
     * @return
     */
    @RequestMapping(value = "/mrTechInvestAppReq.do")
    public String mrTechInvestAppReq(TechInvestVO techInvestVO, Model model ){
    	
    	// 투자비산정내용 승인요청 수행팀 팀장
        techInvestService.insertMrTechInvestAppReq(techInvestVO);
        
        return "redirect:mrTechInvest.do?mrReqNo=" + techInvestVO.getMrReqNo()+"&mrAction=mrTechInvestAppReq";
    }

    /**
     * 투자비 산정 결재
     * @param techInvestVO
     * @param model
     * @return
     */
    @RequestMapping(value = "/mrTechInvestApp.do")
    public String mrTechInvestApp(TechInvestVO techInvestVO, Model model){
        techInvestService.insertMrTechInvestApp(techInvestVO.getMrReqNo());
        return "redirect:mrComplete.do?mrReqNo=" + techInvestVO.getMrReqNo();
    }

    /**
     * skip 기능 (사용 하지 않음)
     * @param techInvestVO
     * @param model
     * @return
     */
    @RequestMapping(value = "/mrTechInvestSkip.do")
    public String mrTechInvestSkip(TechInvestVO techInvestVO, Model model){
        techInvestService.insertMrTechInvestApp(techInvestVO.getMrReqNo());
        return "redirect:mrTechInvest.do?mrReqNo=" + techInvestVO.getMrReqNo();
    }

    /**
     * 투자비 산정 반려
     * @param techInvestVO
     * @param model
     * @return
     */
    @RequestMapping(value = "/mrTechInvestReturn.do")
    public String mrTechInvestReturn(TechInvestVO techInvestVO, Model model){
    	for(int i=0; i<techInvestVO.getAppLine().size(); i++){
    		ChrgrChgHist vo = techInvestVO.getAppLine().get(i);    	
    	}   	
    	
        techInvestService.insertMrTechInvestReturn(techInvestVO);
        
        return "redirect:mrTechInvest.do?mrReqNo=" + techInvestVO.getMrReqNo();
    }
    
    /**
     * (201904추가)투자비 산정 반송
     * @param techInvestVO
     */
    @RequestMapping(value = "/mrTechInvestBack.do")
    public String mrTechInvestBack(TechInvestVO techInvestVO, Model model){
    	//System.out.println("wj:반송처리 시작(mrTechInvestBack)  : " );
        
    	//투자비 산정 반송
        techInvestService.updateMrTechInvestBack(techInvestVO);
        
        //반송완료 후 기술검토항목 조회
        return "redirect:mrTech.do?mrReqNo=" + techInvestVO.getMrReqNo();
    }

}
